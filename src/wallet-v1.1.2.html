<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Wallet & Chat XMTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>


    <!-- Google Fonts -->

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Major+Mono+Display&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        #status {
            word-break: break-word;
        }

        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
        }

        .sent {
            background-color: #4f46e5;
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }

        .received {
            background-color: #374151;
            color: #d1d5db;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }

        /* --- NUEVOS ESTILOS PARA METADATOS DEL MENSAJE --- */
        .message-metadata {
            align-self: flex-end;
            margin-top: 4px;
            font-size: 0.7rem;
            color: #9ca3af;
            /* gray-400 */
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sent .message-metadata {
            color: #e5e7eb;
            /* gray-200, para mejor contraste */
        }

        .status-icon svg {
            width: 1rem;
            /* 16px */
            height: 1rem;
            /* 16px */
        }

        /* --- FIN DE NUEVOS ESTILOS --- */
        .handshake-message {
            width: 100%;
            text-align: center;
            margin: 1rem 0;
            font-size: 0.85rem;
            color: #9ca3af; /* gray-400 */
        }

        .handshake-message .content {
            background-color: #2d3748; /* gray-700 */
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
        }


        #messagesContainer,
        #installationsList {
            scroll-behavior: smooth;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .view.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Nuevo loader horizontal */
        @keyframes loader-horizontal {
            0% {
                width: 0%;
                transform: translateX(-100%);
            }
            50% {
                width: 100%;
                transform: translateX(0%);
            }
            100% {
                width: 0%;
                transform: translateX(100%);
            }
        }


        .nav-btn.active {
            color: #818cf8;
        }

        #qr-code canvas {
            width: 100% !important;
            height: auto !important;
            border-radius: 0.75rem;
        }

        #scanner-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
        }

        #notificationBanner {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Estilos para el contador de mensajes no leídos */
        .unread-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            /* background-color: #222; */
            background-color: #44ef55ff;
            /* background-color: #ef4444; */
            /* red-500 */
            color: white;
            border-radius: 9999px;
            width: 1.25rem;
            height: 1.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .contact-item .unread-badge {
            position: static;
            margin-left: auto;
            min-width: 1.5rem;
            padding: 0 0.25rem;
        }

        /* --- NUEVOS ESTILOS PARA BOTONES DE CHAT --- */
        @keyframes scale-in {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-scale-in {
            animation: scale-in 0.1s ease-out;
        }

        /* .text-gray-500 {
    --tw-text-opacity: 1;
    color: var(--tw-translate-y);
        } */

        .status-icon svg {
            /* width: 1rem; */
            /* height: 1rem; */
            color: white !important
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .contacts-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 300px;
            background-color: #1f2937;
            border-left: 1px solid #374151;
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            will-change: transform;
            display: flex;
            flex-direction: column;
        }

        .contacts-sidebar.active {
            transform: translateX(0);
        }

        .user-profile-section {
            padding: 1rem;
            border-bottom: 1px solid #374151;
            background-color: #111827;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: white;
        }

        .contacts-list-sidebar {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .contacts-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-sidebar-btn {
            color: #9ca3af;
            transition: color 0.2s;
        }

        .close-sidebar-btn:hover {
            color: white;
        }

        @media (max-width: 640px) {
             body {
                /* height: 100vh !important; */
                height: 92vh !important;
            }
            .contacts-sidebar {
                width: 100%;
            }
        }

        .max-w-md {
    max-width: unset!important;
}

        /* Styles for the user info card */
        #userInfoCard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
        }
        #userInfoCard.active {
            display: block;
        }
        #userInfoCard img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            margin: 0 auto 1rem;
            border: 2px solid #4f46e5; /* border-indigo-600 */
        }
        #userInfoCard h4 {
            text-align: center;
            margin-bottom: .5rem;
            font-size: 1.25rem;
            font-weight: bold;
        }
        #userInfoCard p {
            font-size: .9rem;
            text-align: center;
            color: #9ca3af; /* text-gray-400 */
            word-wrap: break-word;
            margin-bottom: 1.5rem;
        }
        #userInfoCard .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #d1d5db; /* text-gray-300 */
            font-size: 1.5rem;
            cursor: pointer;
        }

        #brand-tag{
            background-color: #4f46e5;
            /* font-family:  */
        }

    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center h-screen sm:p-4">


    <!-- =========== FIXED SIDE TAG =========== -->

        <a href="#" id="brand-tag"
        class="block fixed top-1/2 left-0 z-40  text-white font-bold text-xs tracking-widest py-2 px-1 cursor-pointer hover:bg-[#EA580C] transition-colors"
        style="font-family: 'Major Mono Display', monospace; writing-mode: vertical-rl; transform: translateY(-50%) rotate(180deg); border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem;">

        CHATWALLET

    </a>
    <!-- BANNER DE NOTIFICACIÓN -->
    <div id="notificationBanner"
        class="fixed top-0 left-1/2 -translate-x-1/2 w-11/12 max-w-md mt-4 bg-indigo-600 text-white p-3 rounded-lg shadow-xl cursor-pointer z-50 hidden opacity-0 -translate-y-12">
        <div class="flex justify-between items-center">
            <div>
                <p id="notificationSender" class="font-bold text-sm"></p>
                <p id="notificationContent" class="text-sm truncate"></p>
            </div>
            <button id="closeNotification" class="text-2xl leading-none text-white/70 hover:text-white">&times;</button>
        </div>
    </div>

    <!-- Modal de Marca -->
    <div id="brandModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-8 w-full max-w-xs text-center space-y-4 relative">
             <button id="closeBrandModal" class="absolute top-2 right-2 p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
            <img src="apple-touch-icon.png" alt="ChatWallet Icon" class="w-24 h-24 mx-auto rounded-full shadow-indigo-500/50 shadow-lg">
            <h2 class="text-2xl font-bold" style="font-family: 'Major Mono Display', monospace;">CHATWALLET</h2>
            <p class="text-sm text-gray-400">V 1.1.2</p>
            <a href="https://github.com/energiasonora/chatWallet" target="_blank" rel="noopener noreferrer"
                class="inline-block w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-colors duration-200">
                Ver en GitHub
            </a>
        </div>
    </div>


   <!-- User Info Card (hidden by default) -->
   <div id="userInfoCard">
       <button id="closeUserCard" class="close-btn">&times;</button>
       <img id="userCardAvatar" src="static/anonym.jpg" alt="User Avatar">
       <h4 id="userCardName"></h4>
       <p id="userCardAddress" class="font-mono"></p>
       <!-- DID information will be populated here -->
   </div>

     <div class="w-full max-w-md h-full bg-gray-800 sm:rounded-2xl shadow-lg flex flex-col overflow-hidden">

        <!-- Header -->
        <header id="appHeader" class="hidden p-4 bg-gray-900/30 flex justify-between items-center space-x-2">
            <div id="userDidTrigger" class="flex items-center space-x-2 overflow-hidden cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-indigo-400 flex-shrink-0">
                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
                </svg>
                <div id="address" class="text-sm text-gray-400 truncate"></div>
            </div>
            <div class="flex items-center space-x-1">
                <button id="copyAddressButton" title="Copiar dirección"
                    class="text-gray-500 hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-700">
                    <svg id="copyIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                    </svg>
                    <svg id="checkIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" class="hidden text-green-400">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </button>
                <button id="settingsBtn" title="Configuración"
                    class="text-gray-500 hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </button>
                <button id="burgerMenuBtn" title="Menú de Contactos"
                    class="text-gray-500 hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 overflow-y-auto">
            <!-- VISTA DE INICIO -->
            <div id="initView" class="active view flex-col items-center justify-center text-center h-full">
                <img src="apple-touch-icon.png" alt="ChatWallet Icon"
                    class="w-28 h-28 mb-6 rounded-full shadow-indigo-500/50 shadow-lg">
                <h1 class="text-3xl font-bold text-white">Crypto Wallet & Chat</h1>
                <p class="text-gray-400 mt-2 mb-6">Tu puerta de entrada a la Web3</p>
                <div id="initActions" class="w-full max-w-xs space-y-3 hidden">
                    <button id="createWalletButton"
                        class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-colors duration-200">
                        Crear Nueva Billetera
                    </button>
                    <button id="restoreWalletButton"
                        class="w-full px-4 py-3 font-semibold text-indigo-300 bg-gray-700 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-colors duration-200">
                        Restaurar Billetera
                    </button>
                </div>
                <div id="initLoader" class="w-full max-w-xs flex justify-center items-center h-[106px]">
                    <!-- Loader horizontal -->
                    <div class="w-3/4 bg-gray-700 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-indigo-500 h-1.5 rounded-full" style="animation: loader-horizontal 2s ease-in-out infinite;">
                        </div>
                    </div>
                </div>
                <div id="status" class="text-center text-gray-400 p-4 mt-4 min-h-[2rem]"></div>
            </div>


            <!-- VISTA PRINCIPAL (WALLET) -->
            <div id="walletView" class="view flex-col items-center justify-start space-y-6 h-full">
                <div class="w-full max-w-[250px] p-4 bg-white rounded-xl shadow-lg">
                    <div id="qr-code"></div>
                </div>

                <!-- Balance Display with Token Selector -->
                <div class="relative text-center w-full max-w-xs">
                    <button id="tokenSelectorToggle"
                        class="w-full text-center p-2 rounded-lg hover:bg-gray-700/50 transition-colors">
                        <p id="chainNameDisplay" class="text-gray-400 text-sm">Balance (Arbitrum Sepolia)</p>
                        <div class="flex items-center justify-center space-x-2">
                            <p id="balanceDisplay" class="text-4xl font-bold">0.00 ETH</p>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-gray-500">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </button>
                    <div id="gasBalanceDisplay"
                        class="hidden flex items-center justify-center space-x-1 mt-1 text-xs text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 8.5L14.5 9" />
                            <path d="M11.5 10.5L12 11" />
                            <path d="M9.5 8.5L10 9" />
                            <path d="M17 11.5L17.5 12" />
                            <path d="M21.5 12.5a2.5 2.5 0 1 1-5 0c0-1.6 1-2.5 2.5-4 1.5 1.5 2.5 2.4 2.5 4Z" />
                            <path d="M15.5 12.5a2.5 2.5 0 1 1-5 0c0-1.6 1-2.5 2.5-4 1.5 1.5 2.5 2.4 2.5 4Z" />
                            <path d="M9.5 12.5a2.5 2.5 0 1 1-5 0c0-1.6 1-2.5 2.5-4 1.5 1.5 2.5 2.4 2.5 4Z" />
                            <path d="M2.5 20a2.5 2.5 0 1 0 5 0 2.5 2.5 0 1 0-5 0Z" />
                        </svg>
                        <span>Gas:</span>
                        <span id="gasBalanceValue">0.0000 ETH</span>
                    </div>
                    <!-- Token Selector Menu -->
                    <div id="tokenSelectorMenu"
                        class="absolute z-10 mt-2 w-full bg-gray-700/90 backdrop-blur-sm rounded-xl shadow-lg hidden origin-top animate-scale-in">
                        <!-- Tokens will be populated here by JS -->
                    </div>
                </div>

                <div class="w-full grid grid-cols-3 gap-3 pt-4">
                    <button id="sendBtn"
                        class="flex flex-col items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="19" x2="12" y2="5" />
                            <polyline points="5 12 12 5 19 12" />
                        </svg>
                        <span class="mt-2 text-sm font-semibold">Enviar</span>
                    </button>
                    <button id="scanQrBtn"
                        class="flex flex-col items-center p-3 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <line x1="8" y1="12" x2="16" y2="12" />
                        </svg>
                        <span class="mt-2 text-sm font-semibold">Escanear</span>
                    </button>
                    <button class="flex flex-col items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <polyline points="19 12 12 19 5 12" />
                        </svg>
                        <span class="mt-2 text-sm font-semibold">Recibir</span>
                    </button>
                </div>
            </div>

            <!-- Removed contactsView - now in sidebar -->

            <!-- VISTA DE CHAT -->
            <div id="chatView" class="view flex-col h-full">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <button id="backToContactsBtn" class="mr-2 p-2 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12" />
                            <polyline points="12 19 5 12 12 5" />
                        </svg>
                    </button>
                    <div class="flex flex-col cursor-pointer flex-grow overflow-hidden" id="chatHeaderInfo">
                        <h2 id="chattingWith" class="text-lg font-bold truncate">Chat</h2>
                        <span id="chatStatusIndicator" class="text-xs text-gray-400"></span>
                    </div>
                    <!-- Botones de acción en el header del chat -->
                    <div class="flex items-center space-x-2 ml-2 flex-shrink-0">
                        <button id="headerSendBtn" title="Enviar Crypto" class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-full transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                        </button>
                        <button id="headerRequestBtn" title="Solicitar Pago" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer"
                    class="flex-grow overflow-y-auto bg-gray-900/50 p-4 rounded-lg flex flex-col space-y-4 w-full mb-4">
                </div>

                <!-- INICIO: ÁREA DE ACCIONES Y FORMULARIO DE MENSAJE MODIFICADA -->
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <button id="chatActionsToggle" type="button"
                            class="p-3 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" class="transition-transform duration-300">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                        </button>
                        <div id="chatActionsContainer"
                            class="absolute bottom-full mb-2 w-52 bg-gray-700/90 backdrop-blur-sm rounded-xl shadow-lg hidden origin-bottom-left animate-scale-in">
                            <button id="chatSendCryptoBtn"
                                class="w-full text-left p-3 hover:bg-gray-600/50 flex items-center space-x-3 rounded-t-xl transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="text-indigo-400">
                                    <line x1="12" y1="19" x2="12" y2="5" />
                                    <polyline points="5 12 12 5 19 12" />
                                </svg>
                                <span class="font-semibold">Enviar Crypto</span>
                            </button>
                            <button id="chatRequestCryptoBtn"
                                class="w-full text-left p-3 hover:bg-gray-600/50 flex items-center space-x-3 rounded-b-xl transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="text-green-400">
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <polyline points="19 12 12 19 5 12" />
                                </svg>
                                <span class="font-semibold">Solicitar Pago</span>
                            </button>
                        </div>
                    </div>
                    <form id="sendMessageForm" class="flex-grow flex items-center space-x-2">
                        <input type="text" id="messageInput" placeholder="Escribe un mensaje..."
                            class="flex-grow bg-gray-700 border-0 text-white rounded-full px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none"
                            required>
                        <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold p-3 rounded-full flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m22 2-7 20-4-9-9-4Z" />
                                <path d="m22 2-11 11" />
                            </svg>
                        </button>
                    </form>
                </div>
                <!-- FIN: ÁREA MODIFICADA -->
            </div>

        </main>

        <!-- Backup Reminder (Fixed Position) -->
        <div id="backup-reminder"
            class="hidden absolute bottom-[60px] left-0 right-0 p-4 z-20 transition-transform duration-300 translate-y-full">
            <div class="relative w-full bg-yellow-900/80 backdrop-blur-sm border border-yellow-600 text-yellow-300 p-3 rounded-xl shadow-lg text-sm">
                <button id="closeBackupReminderBtn" class="absolute top-1 right-1 p-1 rounded-full hover:bg-yellow-700/50 text-xl leading-none">&times;</button>
                <div class="pr-5">
                    <p class="font-semibold">¡Copia de seguridad pendiente!</p>
                    <p class="text-xs text-yellow-400 mb-2">Asegura tus fondos guardando tu frase de recuperación.</p>
                </div>
                <button id="backupNowBtn" class="w-full text-sm mt-1 bg-yellow-500 text-black py-1.5 px-4 rounded-lg font-bold hover:bg-yellow-400 transition-colors">Hacer copia de seguridad ahora</button>
            </div>
        </div>
        <!-- Navegación -->
        <nav id="appNav" class="hidden grid-cols-1 gap-4 p-2 bg-gray-900/30">
            <button data-view="walletView"
                class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors duration-200 active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
                </svg>
                <span class="text-xs mt-1">Wallet</span>
            </button>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div> 

    <!-- Contacts Sidebar -->
    <div id="contactsSidebar" class="contacts-sidebar">
        <!-- Header -->
        <div class="contacts-sidebar-header">
            <h2 class="text-lg font-bold">Contactos</h2>
            <button id="closeSidebarBtn" class="close-sidebar-btn p-2 rounded-full hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- User Profile Section -->
        <div class="user-profile-section">
            <div class="flex items-center space-x-3">
                <div id="userAvatar" class="user-avatar">
                    <span id="userInitials">CW</span>
                </div>
                <div class="flex-grow">
                    <p id="userProfileName" class="font-semibold text-sm">Usuario</p>
                    <p id="userProfileAddress" class="text-xs text-gray-400 truncate">0x0000...0000</p>
                </div>
            </div>
        </div>

        <!-- Contact Actions -->
        <div class="px-4 py-3 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">Gestionar Contactos</span>
                <div class="flex items-center space-x-2">
                    <!-- Import/Export/Add buttons -->
                    <button id="importContactsBtn" title="Importar Contactos"
                        class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                    </button>
                    <input type="file" id="importContactsInput" class="hidden" accept=".json">
                    <button id="exportContactsBtn" title="Exportar Contactos"
                        class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                    </button>
                    <button id="addContactBtnSidebar" title="Añadir Contacto"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Contacts List -->
        <div id="contactsListSidebar" class="contacts-list-sidebar">
            <!-- Contacts will be populated here -->
        </div>
    </div>

    <!-- MODALS & OVERLAYS -->
    <!-- Vista Escáner QR -->
    <div id="scannerView"
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm hidden flex-col items-center justify-center p-4 z-50">
        <div id="scanner-container"
            class="relative w-full max-w-sm aspect-square bg-gray-700 rounded-2xl overflow-hidden">
            <div id="qr-reader" class="w-full"></div>
        </div>
        <button id="closeScannerBtn" class="mt-6 px-6 py-2 bg-red-600 text-white rounded-lg">Cancelar</button>
    </div>

    <!-- Modal Enviar Transacción -->
    <div id="sendModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-40">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 id="sendModalTitle" class="text-lg font-bold">Enviar ETH (Arbitrum Sepolia)</h3>
            <form id="sendForm" class="space-y-4">
                <div>
                    <label for="recipientAddress" class="block text-sm text-gray-400 mb-1">Dirección del
                        destinatario</label>
                    <input type="text" id="recipientAddress" required placeholder="0x..."
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                </div>
                <div>
                    <label for="amount" class="block text-sm text-gray-400 mb-1">Monto</label>
                    <input type="number" step="0.01" id="amount" required placeholder="0.0"
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-400 mt-1">Balance: <span id="modalBalance">0.0000</span> ETH</p>
                </div>
                <div id="txStatus"
                    class="text-center text-sm min-h-[4rem] flex items-center justify-center p-2 bg-gray-900/50 rounded-lg">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelSendBtn"
                        class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
                    <button type="submit" id="sendTxBtn"
                        class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center space-x-2 w-28">
                        <span>Enviar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Copia de Seguridad -->
    <div id="backupWalletModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-yellow-300">Copia de Seguridad</h3>
                <button id="closeBackupModal" class="p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div id="backupWarningView">
                <div class="bg-red-900/50 border border-red-500 text-red-300 text-sm rounded-lg p-3 my-4">
                    <p><strong>¡ADVERTENCIA DE SEGURIDAD!</strong></p>
                    <p class="mt-2">Estás a punto de revelar tus claves secretas. NUNCA compartas esta información. Cualquiera con acceso a ellas puede robar tus fondos de forma irreversible.</p>
                </div>
                <button id="showBackupKeysBtn" class="w-full px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700">Entiendo el riesgo, mostrar claves</button>
                <button id="cancelBackupBtn" class="w-full mt-2 px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
            </div>
            <div id="backupKeysView" class="hidden space-y-4">
                <div id="backupMnemonicContainer" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Frase Mnemónica (12 palabras)</label>
                    <div class="relative">
                        <p id="backupMnemonic" class="w-full bg-gray-900 rounded-lg p-3 font-mono text-sm text-gray-300 select-all"></p>
                        <button onclick="copyBackupData('backupMnemonic', this)" class="absolute top-2 right-2 text-gray-400 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Clave Privada</label>
                    <div class="relative">
                        <p id="backupPrivateKey" class="w-full bg-gray-900 rounded-lg p-3 font-mono text-xs text-gray-300 select-all break-all"></p>
                        <button onclick="copyBackupData('backupPrivateKey', this)" class="absolute top-2 right-2 text-gray-400 hover:text-white p-1">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>
                        </button>
                    </div>
                </div>
                <button id="closeBackupModalBtn" class="w-full px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">He guardado mis claves</button>
            </div>
        </div>
    </div>

    <!-- Modal Añadir/Editar Contacto -->
    <div id="addContactModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-40">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 id="contactModalTitle" class="text-lg font-bold">Añadir Nuevo Contacto</h3>
            <form id="addContactForm" class="space-y-4">
                <input type="hidden" id="editContactIndex" value="-1">
                <div>
                    <label for="contactName" class="block text-sm text-gray-400 mb-1">Nombre</label>
                    <input type="text" id="contactName" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <p id="contactNameStatus" class="text-xs mt-1 min-h-[1rem]"></p>
                </div>
                <div>
                    <label for="contactAddress" class="block text-sm text-gray-400 mb-1">Dirección / XMTP ID</label>
                   <div class="flex items-center space-x-2">
                       <input type="text" id="contactAddress" required
                        class="flex-grow bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" id="scanForContactAddressBtn"
                               class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg flex-shrink-0">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                   <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                   <line x1="8" y1="12" x2="16" y2="12"></line>
                               </svg>
                           </button>
                   </div>
               </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelAddContact"
                        class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Restaurar Billetera -->
    <div id="restoreWalletModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-40">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-bold">Restaurar Billetera</h3>

            <div class="grid grid-cols-2 gap-2 bg-gray-900/50 p-1 rounded-lg">
                <button id="restoreModePrivateKey"
                    class="restore-mode-btn bg-indigo-600 text-white rounded-md py-1 text-sm font-semibold">Clave
                    Privada</button>
                <button id="restoreModeMnemonic"
                    class="restore-mode-btn text-gray-400 rounded-md py-1 text-sm font-semibold">Frase
                    Mnemónica</button>
            </div>

            <form id="restoreWalletForm" class="space-y-4">
                <div>
                    <label for="restoreInput" class="sr-only">Clave o Frase</label>
                    <textarea id="restoreInput" rows="3" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                        placeholder="Pega tu clave privada..."></textarea>
                </div>
                <p id="restoreError" class="text-red-400 text-sm min-h-[1.25rem]"></p>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelRestoreWallet"
                        class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Restaurar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configuración -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-40">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold">Configuración</h3>
                <button id="closeSettingsModal"
                    class="p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div class="space-y-2">
                <button id="backupWalletSettingsBtn" class="w-full px-4 py-2 font-semibold text-yellow-300 bg-yellow-900/50 border border-yellow-700 rounded-lg hover:bg-yellow-800/50 transition-colors">
                    Hacer Copia de Seguridad
                </button>
            </div>
            <hr class="border-gray-600">
            <div class="space-y-2 text-center text-sm">
                <div id="privateKey" class="text-red-400 break-all font-mono text-xs p-2 bg-gray-900/50 rounded"></div>
            </div>
            <button id="forgetWalletButton"
                class="w-full px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Olvidar
                Billetera</button>
            <hr class="border-gray-600">
            <h2 class="text-md text-center font-semibold text-indigo-300">Gestionar Instalaciones</h2>
            <div id="installationsList"
                class="bg-gray-900/50 p-3 rounded-lg text-sm space-y-2 max-h-40 overflow-y-auto"></div>

            <hr class="border-gray-600">
            <h2 class="text-md text-center font-semibold text-indigo-300">Gestionar Redes</h2>
            <button id="manageNetworksBtn"
                class="w-full mt-2 px-4 py-2 font-semibold text-white bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors">
                Abrir Gestor de Redes
            </button>

            <!-- Sección de Versión y Repositorio añadida aquí -->
            <div class="text-center text-xs text-gray-500 pt-4 border-t border-gray-700 mt-4">
                <p>Versión 1.1.0</p>
                <a href="https://github.com/tu-usuario/tu-repositorio" target="_blank" rel="noopener noreferrer"
                    class="text-indigo-400 hover:underline">
                    Ver en GitHub
                </a>
            </div>
        </div>
    </div>

    <!-- Modal Gestionar Redes -->
    <div id="manageNetworksModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold">Gestionar Redes</h3>
                <button id="closeManageNetworksModalBtn"
                    class="p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
            </div>

            <div id="networksListContainer"
                class="flex-grow overflow-y-auto min-h-0 space-y-2 bg-gray-900/50 p-2 rounded-lg">
                <!-- Lista de redes se renderizará aquí -->
            </div>

            <div class="flex-shrink-0 pt-3 border-t border-gray-700">
                <button id="openAddNetworkModalBtn"
                    class="w-full px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Añadir Nueva Red</button>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Nueva Red -->
    <div id="addNewNetworkModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm flex flex-col max-h-[90vh]">
            <form id="addNetworkForm" class="flex flex-col h-full">
                <input type="hidden" id="editNetworkIndex" value="-1">
                <div class="flex justify-between items-center flex-shrink-0 mb-4">
                    <h3 id="networkModalTitle" class="text-lg font-bold">Añadir Nueva Red</h3>
                    <button type="button" id="closeAddNetworkModalBtn"
                        class="p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
                </div>
    
                <div class="overflow-y-auto p-1 space-y-3 flex-grow">
                    <input type="text" id="networkName" placeholder="Nombre de la Red" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="networkChainId" placeholder="Chain ID" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="url" id="networkRpcUrl" placeholder="URL del RPC" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="url" id="networkExplorerUrl" placeholder="URL del Explorador (Opcional)"
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="nativeSymbol" placeholder="Símbolo Nativo (e.g. ETH)" required
                        class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="pt-2 border-t border-gray-700/50">
                        <h5 class="text-sm font-semibold text-gray-400 mb-2">Añadir Token (Opcional)</h5>
                        <input type="text" id="tokenAddress" placeholder="Dirección del Contrato del Token"
                            class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="tokenSymbol" placeholder="Símbolo del Token (e.g. USDT)"
                            class="w-full bg-gray-700 rounded-lg p-2 mt-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <button type="submit"
                    class="w-full px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 flex-shrink-0 mt-4">Guardar
                    Red</button>
            </form>
        </div>
    </div>

    <!-- Direct Chat View -->
    <div id="direct-chat" class="hidden absolute inset-0 bg-gray-900 z-50 p-4 flex flex-col">
        <div class="flex items-center justify-between pb-4 border-b border-gray-700">
            <h2 class="text-xl font-bold">Direct Chat</h2>
            <button id="close-direct-chat" class="text-white">&times;</button>
        </div>
        <div id="direct-chat-history" class="flex-1 overflow-y-auto my-4"></div>
        <div class="flex items-center">
            <input type="text" id="direct-chat-input" class="flex-1 bg-gray-800 rounded-full py-2 px-4" placeholder="Type a message...">
            <button id="direct-chat-send" class="ml-4 bg-indigo-600 rounded-full p-2">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </button>
        </div>
    </div>

    <!-- User DID Window -->
    <div id="userDidWindow" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold">Your Decentralized Identity</h3>
                <button id="closeUserDidWindow" class="p-1 rounded-full hover:bg-gray-700 text-2xl leading-none">&times;</button>
            </div>
            
            <div class="flex items-center space-x-4">
                <img id="userDidAvatar" src="static/anonym.jpg" alt="User Avatar" class="w-20 h-20 rounded-full border-2 border-indigo-500 cursor-pointer">
                <input type="file" id="avatarUpload" class="hidden" accept="image/*">
                
                <div class="flex-grow">
                    <label for="userDidAlias" class="block text-sm text-gray-400 mb-1">Alias Name</label>
                    <input type="text" id="userDidAlias" placeholder="Your Alias" class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <p id="usernameStatus" class="text-xs mt-1 min-h-[1rem] font-medium"></p>
                </div>
            </div>

            <div>
                <label for="userDidLinks" class="block text-sm text-gray-400 mb-1">Share Links (one per line)</label>
                <textarea id="userDidLinks" rows="3" class="w-full bg-gray-700 rounded-lg p-2 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://my-website.com\nhttps://twitter.com/my-handle"></textarea>
            </div>
            
            <div>
                <h4 class="text-md font-semibold text-gray-300">Public Attestations/Badges</h4>
                <div id="userDidBadges" class="mt-2 text-sm text-gray-400 bg-gray-900/50 p-3 rounded-lg min-h-[50px]">
                    <p>Your badges will appear here.</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-2">
                <button id="saveUserDid" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>


    <script src="js/Tone.min.js"></script>
    <!-- Ethers.js v6 -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script> -->
    <script src="js/ethers-6.13.2.umd.min.js"></script>

    <script type="module">
        import { Client, ContentTypeId } from '@xmtp/browser-sdk';
        import { ReadReceiptCodec } from '@xmtp/content-type-read-receipt';
        window.Client = Client;
        window.ContentTypeId = ContentTypeId;
        window.ReadReceiptCodec = ReadReceiptCodec;


        import { ethers, Wallet, isAddress, getBytes, formatEther, JsonRpcProvider, Contract } from 'ethers';
        window.Wallet = Wallet;
        window.isAddress = isAddress;
        window.ethers = ethers;
        window.getBytes = getBytes;
        window.JsonRpcProvider = JsonRpcProvider;
        window.formatEther = formatEther;
        window.Contract = Contract;

    </script>
    <script>

        // --- BLOCKCHAIN INTEGRATION CONSTANTS ---
                // const arbSepoliaRpc = "https://sepolia-rollup.arbitrum.io/rpc";
        // const generalOptions = [
        //      {
        //         "TOKEN_CHAIN_NAME": 'Arbitrum Sepolia',
        //         "TOKEN_CHAINID": '421614',
        //         "EXPLORER": 'https://sepolia.arbiscan.io/',
        //         "API": 'https://arbitrum-sepolia.infura.io/v3/b17405e634bd40308be3eb4fa2485c9a',
        //         "NATIVE_SYMBOL": 'ETH',
        //         "CHATWALLET_TOKEN_ADDRESS" : "0x2aC45C33602E1a8450302100F1897BFF6C91a5d6",
        //         "CHATWALLET_DID_ADDRESS" : "0x4ccA3288A4319c9c44e8797087F8776A863342F5",
        //     }
        // ]

        const defaultNetworks = [
            {
                "TOKEN_CHAIN_NAME": 'Arbitrum Sepolia',
                "TOKEN_CHAINID": '421614',
                "EXPLORER": 'https://sepolia.arbiscan.io/',
                "API": 'https://arbitrum-sepolia.infura.io/v3/b17405e634bd40308be3eb4fa2485c9a',
                "NATIVE_SYMBOL": 'ETH',
                "CHATWALLET_DID_ADDRESS" : "0x96Df83456f0B4d161C3E00278Ba33670c796523d",
                "CHATWALLET_TOKEN_ADDRESS" : "0x2aC45C33602E1a8450302100F1897BFF6C91a5d6",
                "CHATWALLET_DID_ADDRESS" : "0x4ccA3288A4319c9c44e8797087F8776A863342F5",
            },
            {
                "TOKEN_CHAIN_NAME": 'Arbitrum One',
                "TOKEN_CHAINID": '42161',
                "EXPLORER": 'https://arbiscan.io/',
                "API": 'https://arb1.arbitrum.io/rpc',
                "NATIVE_SYMBOL": 'ETH'
            },
            {
                "TOKEN_CHAIN_NAME": 'USDC on Arbitrum',
                "TOKEN_CHAINID": '42161',
                "EXPLORER": 'https://arbiscan.io/',
                "API": 'https://arb1.arbitrum.io/rpc',
                "NATIVE_SYMBOL": 'ETH',
                "TOKEN_ADDRESS": "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
                "TOKEN_SYMBOL": "USDC",
                "DECIMALS": 6
            }
            // {
            //     "TOKEN_CHAIN_NAME": 'Base Sepolia',
            //     "TOKEN_CHAINID": '84532',
            //     "EXPLORER": 'https://sepolia.basescan.org/',
            //     "API": 'https://sepolia.base.org',
            //     "NATIVE_SYMBOL": 'ETH'
            // }
        ];

CHATWALLET_DID_ABI = [ { "inputs": [ { "internalType": "address", "name": "_tokenAddress", "type": "address" } ], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [ { "internalType": "address", "name": "owner", "type": "address" } ], "name": "OwnableInvalidOwner", "type": "error" }, { "inputs": [ { "internalType": "address", "name": "account", "type": "address" } ], "name": "OwnableUnauthorizedAccount", "type": "error" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "uint256", "name": "newTokenPrice", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "newNativePrice", "type": "uint256" } ], "name": "PricesUpdated", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "string", "name": "newUsername", "type": "string" }, { "indexed": false, "internalType": "string", "name": "newMetadataURI", "type": "string" } ], "name": "ProfileUpdated", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "newToken", "type": "address" } ], "name": "TokenUpdated", "type": "event" }, { "inputs": [], "name": "MAX_LENGTH", "outputs": [ { "internalType": "uint8", "name": "", "type": "uint8" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MIN_LENGTH", "outputs": [ { "internalType": "uint8", "name": "", "type": "uint8" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "chatWalletToken", "outputs": [ { "internalType": "contract IERC20", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "nativePrice", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "", "type": "address" } ], "name": "profiles", "outputs": [ { "internalType": "string", "name": "username", "type": "string" }, { "internalType": "string", "name": "metadataURI", "type": "string" }, { "internalType": "bool", "name": "isRegistered", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "_tokenPrice", "type": "uint256" }, { "internalType": "uint256", "name": "_nativePrice", "type": "uint256" } ], "name": "setPrices", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "_username", "type": "string" }, { "internalType": "string", "name": "_metadataURI", "type": "string" } ], "name": "setProfile", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_newToken", "type": "address" } ], "name": "setToken", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "tokenPrice", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "", "type": "string" } ], "name": "usernameToAddress", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "withdrawNative", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "withdrawTokens", "outputs": [], "stateMutability": "nonpayable", "type": "function" } ]



        arbitrumSepoliaChain = {
            chainId: "0x66eee", // Hexadecimal (decimal: 421613)
            chainName: "Arbitrum Sepolia",
            nativeCurrency: {
                name: "Ether",
                symbol: "ETH",
                decimals: 18,
            },
            rpcUrls: ["https://sepolia-rollup.arbitrum.io/rpc "],
            blockExplorerUrls: ["https://sepolia.arbiscan.io/ "],
        };


        // --- Variables Globales ---
        var chatwalletxmtp = null;
        var currentWallet = null;
        var currentConversation = null;
        var userAddress = null;
        var signer = null;
        var stream = null;
        var contacts = [];
        var provider = null; // Ethers provider
        const processedMessages = new Set();
        let html5QrCodeScanner = null;
        let notificationTimeout = null;
        let currentRestoreMode = 'privateKey';
        let optionsList = [];
        let currentTokenIndex = 0;
        let isSendingFromChat = false;
        let chatRecipientAddress = null;
        let allChainsData = [];
        const erc20Abi = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
        ];

        let isFullscreen = false;
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isDragging = false;

        function toggleFullscreen() {
            if (!isFullscreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                isFullscreen = false;
            }
        }


        // --- Almacenamiento ---
        const WALLET_STORAGE_KEY = 'xmtp-chat-wallet';
        const CONTACTS_STORAGE_KEY = 'xmtp-chat-contacts';
        const NETWORKS_STORAGE_KEY = 'xmtp-chat-networks';
        const SELECTED_NETWORK_KEY = 'xmtp-chat-selected-network';

        // --- DOM Elements ---
        const createWalletButton = document.getElementById('createWalletButton');
        const forgetWalletButton = document.getElementById('forgetWalletButton');
        const copyAddressButton = document.getElementById('copyAddressButton');
        const statusEl = document.getElementById('status');
        const addressEl = document.getElementById('address');
        const privateKeyEl = document.getElementById('privateKey');
        const qrCodeEl = document.getElementById('qr-code');

        const appHeader = document.getElementById('appHeader');
        const appNav = document.getElementById('appNav');
        const allViews = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.nav-btn');
        const balanceDisplay = document.getElementById('balanceDisplay');

        const tokenSelectorToggle = document.getElementById('tokenSelectorToggle');
        const tokenSelectorMenu = document.getElementById('tokenSelectorMenu');
        const chainNameDisplay = document.getElementById('chainNameDisplay');
        const sendModalTitle = document.getElementById('sendModalTitle');
        const gasBalanceDisplay = document.getElementById('gasBalanceDisplay');
        const gasBalanceValue = document.getElementById('gasBalanceValue');

        // Restore Wallet Modal
        const restoreWalletButton = document.getElementById('restoreWalletButton');
        const restoreWalletModal = document.getElementById('restoreWalletModal');
        const cancelRestoreWallet = document.getElementById('cancelRestoreWallet');
        const restoreWalletForm = document.getElementById('restoreWalletForm');
        const restoreInput = document.getElementById('restoreInput');
        const restoreError = document.getElementById('restoreError');
        const restoreModePrivateKeyBtn = document.getElementById('restoreModePrivateKey');
        const restoreModeMnemonicBtn = document.getElementById('restoreModeMnemonic');

        // Notificaciones
        const notificationBanner = document.getElementById('notificationBanner');
        const notificationSender = document.getElementById('notificationSender');
        const notificationContent = document.getElementById('notificationContent');
        const closeNotification = document.getElementById('closeNotification');
        const totalUnreadBadge = document.getElementById('totalUnreadBadge');

        // Contactos (sidebar elements now)
        const addContactBtn = document.getElementById('addContactBtn'); // Keep this for backward compatibility
        const addContactModal = document.getElementById('addContactModal');
        const contactModalTitle = document.getElementById('contactModalTitle');
        const addContactForm = document.getElementById('addContactForm');
        const cancelAddContact = document.getElementById('cancelAddContact');
        const editContactIndexInput = document.getElementById('editContactIndex');
        // Import/Export buttons are now in sidebar
        const importContactsBtn = document.getElementById('importContactsBtn');
        const importContactsInput = document.getElementById('importContactsInput');
        const exportContactsBtn = document.getElementById('exportContactsBtn');


        // Chat
        const chatView = document.getElementById('chatView');
        const backToContactsBtn = document.getElementById('backToContactsBtn');
        const chattingWithEl = document.getElementById('chattingWith');
        const chatStatusIndicator = document.getElementById('chatStatusIndicator');
        const messagesContainer = document.getElementById('messagesContainer');
        const sendMessageForm = document.getElementById('sendMessageForm');
        const messageInput = document.getElementById('messageInput');

        const chatActionsToggle = document.getElementById('chatActionsToggle');
        const chatActionsContainer = document.getElementById('chatActionsContainer');
        const chatSendCryptoBtn = document.getElementById('chatSendCryptoBtn');
        const chatRequestCryptoBtn = document.getElementById('chatRequestCryptoBtn');

        // Settings & Networks
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const manageNetworksBtn = document.getElementById('manageNetworksBtn');
        const backupWalletSettingsBtn = document.getElementById('backupWalletSettingsBtn');
        const manageNetworksModal = document.getElementById('manageNetworksModal');
        const closeManageNetworksModalBtn = document.getElementById('closeManageNetworksModalBtn');
        const openAddNetworkModalBtn = document.getElementById('openAddNetworkModalBtn');
        const addNewNetworkModal = document.getElementById('addNewNetworkModal');
        const closeAddNetworkModalBtn = document.getElementById('closeAddNetworkModalBtn');
        const networksListContainer = document.getElementById('networksListContainer');
        const addNetworkForm = document.getElementById('addNetworkForm');
        const networkNameInput = document.getElementById('networkName');
        const networkChainIdInput = document.getElementById('networkChainId');
        const networkRpcUrlInput = document.getElementById('networkRpcUrl');
        const networkExplorerUrlInput = document.getElementById('networkExplorerUrl');
        const installationsList = document.getElementById('installationsList');

        // Sidebar Elements
        const burgerMenuBtn = document.getElementById('burgerMenuBtn');
        const contactsSidebar = document.getElementById('contactsSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userInitials = document.getElementById('userInitials');
        const userProfileName = document.getElementById('userProfileName');
        const userProfileAddress = document.getElementById('userProfileAddress');
        const contactsListSidebar = document.getElementById('contactsListSidebar');
        const addContactBtnSidebar = document.getElementById('addContactBtnSidebar');

        // Scanner
        const scanQrBtn = document.getElementById('scanQrBtn');
        const scannerView = document.getElementById('scannerView');
        const closeScannerBtn = document.getElementById('closeScannerBtn');

        // Send Modal
        const sendBtn = document.getElementById('sendBtn');
        const sendModal = document.getElementById('sendModal');
        const sendForm = document.getElementById('sendForm');
        const cancelSendBtn = document.getElementById('cancelSendBtn');
        const recipientAddressInput = document.getElementById('recipientAddress');
        const amountInput = document.getElementById('amount');
        const txStatus = document.getElementById('txStatus');
        const sendTxBtn = document.getElementById('sendTxBtn');


        // --- UI Navegación ---
        function showView(viewId) {
            allViews.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');

                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewId);
                });
            }

            if (viewId !== 'chatView') {
                console.log('no es chatView, resetear currentConversation a null');
                currentConversation = null;
            }
        }

        // --- Sidebar Functions ---
        function openSidebar() {
            contactsSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            contactsSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSidebar() {
            if (contactsSidebar.classList.contains('active')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function updateUserProfile() {
            if (currentWallet) {
                const address = currentWallet.address;
                const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
                userProfileAddress.textContent = shortAddress;
                userProfileName.textContent = 'Mi Perfil';

                // Generate initials from address for avatar
                const initials = `C${address.slice(2, 4).toUpperCase()}`;
                userInitials.textContent = initials;
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showView(button.dataset.view);
            });
        });

        // --- Funciones de Billetera y XMTP ---
        async function initializeWalletAndXmtp(wallet, isNewWallet = false) {
              console.log(`

 ██████╗██╗  ██╗ █████╗ ████████╗██╗    ██╗ █████╗ ██╗     ██╗     ███████╗████████╗
██╔════╝██║  ██║██╔══██╗╚══██╔══╝██║    ██║██╔══██╗██║     ██║     ██╔════╝╚══██╔══╝
██║     ███████║███████║   ██║   ██║ █╗ ██║███████║██║     ██║     █████╗     ██║   
██║     ██╔══██║██╔══██║   ██║   ██║███╗██║██╔══██║██║     ██║     ██╔══╝     ██║   
╚██████╗██║  ██║██║  ██║   ██║   ╚███╔███╔╝██║  ██║███████╗███████╗███████╗   ██║   
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝    ╚══╝╚══╝ ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝   ╚═╝   
                                                                                                                               
                                                                       
                               
																				

`);
            currentWallet = wallet;
            const selectedNetwork = optionsList[currentTokenIndex];
            provider = new window.ethers.JsonRpcProvider(selectedNetwork.API);

            updateWalletUI(wallet, isNewWallet);

            if (isNewWallet) {
                const reminder = document.getElementById('backup-reminder');
                reminder.classList.remove('hidden', 'translate-y-full');
            }

            chainNameDisplay.textContent = `Balance (${selectedNetwork.TOKEN_CHAIN_NAME})`;
            sendModalTitle.textContent = `Enviar ${selectedNetwork.NATIVE_SYMBOL || 'ETH'} (${selectedNetwork.TOKEN_CHAIN_NAME})`;

            statusEl.textContent = "Conectando al cliente de XMTP...";
            userAddress = wallet.address;

            try {
                walletSigner = {
                    type: "EOA",
                    getIdentifier: () => ({ identifier: userAddress, identifierKind: "Ethereum" }),
                    signMessage: async (message) => ethers.getBytes(await wallet.signMessage(message)),
                };
                chatwalletxmtp = await Client.create(walletSigner, {
                    env: 'dev',
                    codecs: [new PresenceCodec(), new window.ReadReceiptCodec()]
                });

                appHeader.classList.remove('hidden');
                appHeader.classList.add('flex');
                appNav.classList.remove('hidden');
                appNav.classList.add('grid');
                showView('walletView');

                updateBalance();
                listenForIncomingMessages();
                loadContacts();
                await handleUrlParameters();

                // const fcName = await getFarcasterUsername(wallet.address);
                // if (fcName) {
                //     console.log(`¡Hola @${fcName}! Te reconocimos de Farcaster.`);
                //     document.getElementById('userDidAlias').value = fcName;
                //     // Could also save this to local storage or a more persistent state.
                // }
                
            } catch (error) {
                console.error("Error al inicializar XMTP:", error);
                statusEl.textContent = `Error al inicializar: ${error.message}`;
                resetUI();
            }
        }

        // --- Transacciones con Ethers.js ---
        async function updateBalance() {
            if (!provider || !currentWallet) return;

            const selectedNetwork = optionsList[currentTokenIndex];
            const nativeSymbol = selectedNetwork.NATIVE_SYMBOL || 'ETH';
            let nativeBalanceFormatted;

            // Primero, siempre obtener el saldo nativo (gas) y manejar errores de conexión
            try {
                const nativeBalanceWei = await provider.getBalance(currentWallet.address);
                nativeBalanceFormatted = parseFloat(ethers.formatEther(nativeBalanceWei)).toFixed(4);
                console.log("native balance:", nativeBalanceFormatted);


                gasBalanceValue.textContent = `${nativeBalanceFormatted} ${nativeSymbol}`;
                gasBalanceValue.classList.toggle('text-red-400', parseFloat(nativeBalanceFormatted) < 0.001);

            } catch (gasError) {
                console.error("Error fetching gas balance:", gasError);
                gasBalanceValue.textContent = `Error ${nativeSymbol}`;
                balanceDisplay.textContent = `Error de conexión`; // Mostrar error en el balance principal
                return; // Detener la ejecución si no se puede obtener el balance de gas
            }

            // Ahora, verificar si estamos mostrando un token ERC20 o el token nativo
            if (selectedNetwork.TOKEN_ADDRESS && ethers.isAddress(selectedNetwork.TOKEN_ADDRESS)) {
                // Es un token ERC20
                gasBalanceDisplay.classList.remove('hidden');
                try {
                    const tokenContract = new ethers.Contract(selectedNetwork.TOKEN_ADDRESS, erc20Abi, provider);
                    tknc = tokenContract
                    const decimals = await tokenContract.decimals();
                    const balanceWei = await tokenContract.balanceOf(currentWallet.address);
                    const formattedBalance = parseFloat(ethers.formatUnits(balanceWei, decimals)).toFixed(4);

                    balanceDisplay.textContent = `${formattedBalance} ${selectedNetwork.TOKEN_SYMBOL}`;
                    document.getElementById('modalBalance').textContent = `${nativeBalanceFormatted} ${nativeSymbol}`;

                } catch (tokenError) {
                    console.error("Error fetching token balance:", tokenError);
                    balanceDisplay.textContent = `Error ${selectedNetwork.TOKEN_SYMBOL}`;
                }

            } else {
                // Es el token nativo
                gasBalanceDisplay.classList.add('hidden');
                balanceDisplay.textContent = `${nativeBalanceFormatted} ${nativeSymbol}`;
                document.getElementById('modalBalance').textContent = `${nativeBalanceFormatted} ${nativeSymbol}`;
            }
        }


        async function handleSendTransaction(e) {
            e.preventDefault();
            const recipient = recipientAddressInput.value.trim();
            const amount = amountInput.value.trim();

            setTxStatus('Preparando transacción...', true);

            if (!ethers.isAddress(recipient)) {
                setTxStatus('<span class="text-red-400">Dirección del destinatario inválida.</span>', false);
                return;
            }
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                setTxStatus('<span class="text-red-400">Monto inválido.</span>', false);
                return;
            }

            try {
                const signer = currentWallet.connect(provider);
                const tx = {
                    to: recipient,
                    value: ethers.parseEther(amount)
                };

                setTxStatus('Enviando transacción...', true);
                const txResponse = await signer.sendTransaction(tx);

                setTxStatus('Esperando confirmación...', true);
                await txResponse.wait();

                const txHash = txResponse.hash;
                const shortHash = `${txHash.slice(0, 8)}...${txHash.slice(-6)}`;
                const etherscanUrl = `${optionsList[currentTokenIndex].EXPLORER}tx/${txHash}`;
                setTxStatus(`<span class="text-green-400">¡Éxito!</span> <a href="${etherscanUrl}" target="_blank" class="text-indigo-400 hover:underline">${shortHash}</a>`, false);
                updateBalance();

                if (isSendingFromChat && currentConversation && chatRecipientAddress.toLowerCase() === recipient.toLowerCase()) {
                    const txMessage = `[TRANSACTION]${JSON.stringify({ type: 'send', amount: parseFloat(amount), txHash: txHash, network: optionsList[currentTokenIndex] })}`;
                    try {
                        await currentConversation.send(txMessage);
                    } catch (error) {
                        console.error("Fallo al enviar mensaje de confirmación vía XMTP", error);
                    }
                }

                setTimeout(() => {
                    sendModal.classList.add('hidden');
                    sendModal.classList.remove('flex');
                    isSendingFromChat = false;
                    recipientAddressInput.readOnly = false; // Re-enable for general use
                    chatRecipientAddress = null;
                }, 4000);

            } catch (error) {
                console.error("Error en la transacción:", error);
                let errorMessage = "Error desconocido.";
                if (error.code === 'INSUFFICIENT_FUNDS') {
                    errorMessage = "Fondos insuficientes.";
                } else if (error.message) {
                    errorMessage = error.message.slice(0, 60) + '...';
                }
                setTxStatus(`<span class="text-red-400">${errorMessage}</span>`, false);
            }
        }

        function setTxStatus(message, isLoading) {
            txStatus.innerHTML = message;
            sendTxBtn.disabled = isLoading;
            if (isLoading) {
                sendTxBtn.innerHTML = `<span class="w-4 h-4 border-2 rounded-full spinner"></span><span>Procesando</span>`;
            } else {
                sendTxBtn.innerHTML = `<span>Enviar</span>`;
            }
        }

        function renderTokenMenu() {
            tokenSelectorMenu.innerHTML = '';

            // Filtra para mostrar solo las redes favoritas.
            let favoriteNetworks = optionsList
                .map((token, index) => ({ ...token, originalIndex: index })) // Adjunta el índice original
                .filter(token => token.isFavorite);

            // Si no hay favoritos, muestra todas las redes como fallback.
            if (favoriteNetworks.length === 0) {
                favoriteNetworks = optionsList.map((token, index) => ({ ...token, originalIndex: index }));
            }

            favoriteNetworks.forEach((token) => {
                const isSelected = token.originalIndex === currentTokenIndex;
                const item = document.createElement('button');
                item.className = `w-full text-left p-3 hover:bg-gray-600/50 flex items-center justify-between transition-colors rounded-lg ${isSelected ? 'text-indigo-400 font-semibold' : ''}`;
                item.innerHTML = `
                    <span>${token.TOKEN_CHAIN_NAME}</span>
                    ${isSelected ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}
                `;
                item.onclick = () => switchNetwork(token.originalIndex);
                tokenSelectorMenu.appendChild(item);
            });
        }

        async function switchNetwork(index) {
            if (index === currentTokenIndex) {
                tokenSelectorMenu.classList.add('hidden');
                return;
            }
            currentTokenIndex = index;
            localStorage.setItem(SELECTED_NETWORK_KEY, currentTokenIndex.toString());
            const selectedNetwork = optionsList[currentTokenIndex];

            provider = new window.ethers.JsonRpcProvider(selectedNetwork.API);

            chainNameDisplay.textContent = `Balance (${selectedNetwork.TOKEN_CHAIN_NAME})`;
            sendModalTitle.textContent = `Enviar ${selectedNetwork.NATIVE_SYMBOL || 'ETH'} (${selectedNetwork.TOKEN_CHAIN_NAME})`;
            tokenSelectorMenu.classList.add('hidden');
            balanceDisplay.textContent = 'Cargando...';

            renderTokenMenu();

            await updateBalance();
        }

        // --- Restaurar Billetera ---
        function setRestoreMode(mode) {
            currentRestoreMode = mode;
            restoreError.textContent = '';
            if (mode === 'privateKey') {
                restoreModePrivateKeyBtn.classList.add('bg-indigo-600', 'text-white');
                restoreModePrivateKeyBtn.classList.remove('text-gray-400');
                restoreModeMnemonicBtn.classList.remove('bg-indigo-600', 'text-white');
                restoreModeMnemonicBtn.classList.add('text-gray-400');
                restoreInput.placeholder = "Pega tu clave privada...";
            } else {
                restoreModeMnemonicBtn.classList.add('bg-indigo-600', 'text-white');
                restoreModeMnemonicBtn.classList.remove('text-gray-400');
                restoreModePrivateKeyBtn.classList.remove('bg-indigo-600', 'text-white');
                restoreModePrivateKeyBtn.classList.add('text-gray-400');
                restoreInput.placeholder = "Pega tu frase mnemónica de 12 o 24 palabras...";
            }
        }

        async function handleRestoreWallet(e) {
            e.preventDefault();
            const inputValue = restoreInput.value.trim();
            restoreError.textContent = '';
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Restaurando...';

            if (!inputValue) {
                restoreError.textContent = 'El campo no puede estar vacío.';
                submitButton.disabled = false;
                submitButton.textContent = 'Restaurar';
                return;
            }

            let restoredWallet = null;

            try {
                if (currentRestoreMode === 'privateKey') {
                    restoredWallet = new ethers.Wallet(inputValue);
                } else {
                    restoredWallet = ethers.Wallet.fromPhrase(inputValue);
                }

                localStorage.setItem(WALLET_STORAGE_KEY, restoredWallet.privateKey);
                restoreWalletModal.classList.add('hidden');
                restoreWalletModal.classList.remove('flex');
                statusEl.textContent = "Billetera restaurada. Conectando...";
                await initializeWalletAndXmtp(restoredWallet, false);

            } catch (error) {
                console.error("Error al restaurar billetera:", error);
                restoreError.textContent = 'Clave o frase inválida. Por favor, verifica.';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Restaurar';
            }
        }

        // --- Contactos ---
        function loadContacts() {
            const storedContacts = localStorage.getItem(CONTACTS_STORAGE_KEY);
            contacts = storedContacts ? JSON.parse(storedContacts) : [];
            renderContacts();
        }

        function saveContacts() {
            localStorage.setItem(CONTACTS_STORAGE_KEY, JSON.stringify(contacts));
            renderContacts();
        }

        function renderContacts() {
            contacts.sort((a, b) => (b.lastMessageTimestamp || 0) - (a.lastMessageTimestamp || 0));

            contactsListSidebar.innerHTML = '';
            let totalUnread = 0;

            if (contacts.length === 0) {
                contactsListSidebar.innerHTML = `<p class="text-center text-gray-500 mt-8">No tienes contactos. <br>¡Añade uno para empezar a chatear!</p>`;
            } else {
                contacts.forEach((contact) => {
                    const unreadCount = contact.unreadCount || 0;
                    totalUnread += unreadCount;

                    const lastMessageTime = formatTimestampForContactList(contact.lastMessageTimestamp);
                    let lastMessageText = contact.lastMessage || 'Aún no hay mensajes';

                    if (String(lastMessageText).startsWith('[TRANSACTION]')) {
                        lastMessageText = '💸 Transacción';
                    }

                    const statusText = contact.status === 'online' ? '🟢 En línea' : '⚪️ Desconectado';

                    const contactEl = document.createElement('div');
                    contactEl.className = 'contact-item flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition gap-3 mb-2';
                    contactEl.innerHTML = `
                        <div class="flex-grow overflow-hidden">
                            <div class="flex justify-between items-baseline">
                                <p class="font-semibold truncate pr-2">${contact.name}</p>
                                <p class="text-xs text-gray-400 flex-shrink-0">${lastMessageTime}</p>
                            </div>
                            <div class="flex items-center mt-1">
                                <p class="text-xs text-gray-500 truncate flex-grow">${statusText} - ${lastMessageText}</p>
                                ${unreadCount > 0 ? `<span class="unread-badge flex-shrink-0 ml-2">${unreadCount}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex items-center">
                            <button data-address="${contact.address}" class="edit-contact-btn p-2 text-gray-500 hover:text-indigo-400 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button data-address="${contact.address}" class="delete-contact-btn p-2 text-gray-500 hover:text-red-400 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                            </button>
                        </div>
                    `;
                    contactEl.addEventListener('click', async (e) => {
                        if (e.target.closest('.edit-contact-btn') || e.target.closest('.delete-contact-btn')) {
                            return;
                        }
                        await startChatWithContact(contact);
                        closeSidebar(); // Close sidebar when starting chat
                    });

                    contactsListSidebar.appendChild(contactEl);
                });
            }

            document.querySelectorAll('.edit-contact-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const address = e.currentTarget.dataset.address;
                    const index = contacts.findIndex(c => c.address === address);
                    if (index > -1) {
                        openEditContactModal(index);
                    }
                });
            });

            document.querySelectorAll('.delete-contact-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const address = e.currentTarget.dataset.address;
                    const index = contacts.findIndex(c => c.address === address);
                    if (index > -1) {
                        const contact = contacts[index];
                        if (confirm(`¿Seguro que quieres eliminar a ${contact.name}?`)) {
                            contacts.splice(index, 1);
                            saveContacts();
                        }
                    }
                });
            });

            // Update total unread badge in header if needed
            if (totalUnread > 0 && totalUnreadBadge) {
                totalUnreadBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                totalUnreadBadge.classList.remove('hidden');
            } else if (totalUnreadBadge) {
                totalUnreadBadge.classList.add('hidden');
            }
        }

        addContactForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('contactName').value.trim();
            const address = document.getElementById('contactAddress').value.trim();
            const index = parseInt(editContactIndexInput.value);

            if (name && address) {
                if (index > -1) {
                    contacts[index] = { ...contacts[index], name, address };
                } else {
                    contacts.push({
                        name,
                        address,
                        unreadCount: 0,
                        lastMessage: null,
                        lastMessageTimestamp: 0,
                        status: 'offline',
                        lastSeen: null
                    });
                }
                saveContacts();
                closeContactModal();
            }
        });

        function openAddContactModal() {
            contactModalTitle.textContent = "Añadir Nuevo Contacto";
            addContactForm.reset();
            editContactIndexInput.value = "-1";
            addContactModal.classList.remove('hidden');
            addContactModal.classList.add('flex');
        }

        function openEditContactModal(index) {
            const contact = contacts[index];
            contactModalTitle.textContent = "Editar Contacto";
            addContactForm.reset();
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactAddress').value = contact.address;
            editContactIndexInput.value = index;
            addContactModal.classList.remove('hidden');
            addContactModal.classList.add('flex');
        }

        function closeContactModal() {
            addContactModal.classList.add('hidden');
            addContactModal.classList.remove('flex');
        }

        function exportContacts() {
            if (contacts.length === 0) {
                alert("No hay contactos para exportar.");
                return;
            }
            const dataStr = JSON.stringify(contacts, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xmtp_contacts.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportContacts(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedContacts = JSON.parse(e.target.result);
                    if (!Array.isArray(importedContacts) || !importedContacts.every(c => c.name && c.address)) {
                        throw new Error("Formato de archivo inválido.");
                    }

                    if (confirm("¿Quieres fusionar los contactos importados con tu lista actual? Se omitirán los duplicados.")) {
                        const existingAddresses = new Set(contacts.map(c => c.address.toLowerCase()));
                        const newContacts = importedContacts.filter(
                            c => !existingAddresses.has(c.address.toLowerCase())
                        );
                        contacts = [...contacts, ...newContacts];
                        saveContacts();
                        alert(`${newContacts.length} nuevos contactos importados.`);
                    }
                } catch (error) {
                    alert(`Error al importar: ${error.message}`);
                }
                importContactsInput.value = '';
            };
            reader.readAsText(file);
        }

        function autoDetectDate(input) {
            const n = typeof input === 'bigint' ? Number(input) : input;
            if (isNaN(n) || n <= 0) return null;

            if (n < 1e11) return new Date(n * 1000);
            if (n < 1e14) return new Date(n);
            if (n < 1e17) return new Date(n / 1000);
            return new Date(n / 1_000_000);
        }

        function formatTimestampForContactList(timestamp) {
            if (!timestamp) return '';
            const date = autoDetectDate(timestamp);
            if (!date) return '';

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfYesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            if (date >= startOfToday) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else if (date >= startOfYesterday) {
                return 'Ayer';
            } else {
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            }
        }

        // --- Chat ---
        async function startChatWithContact(contact) {
            const contactIndex = contacts.findIndex(c => c.address.toLowerCase() === contact.address.toLowerCase());
            if (contactIndex > -1 && contacts[contactIndex].unreadCount > 0) {
                contacts[contactIndex].unreadCount = 0;
            }

            chattingWithEl.textContent = contact.name;
            updateChatHeaderStatus(contact);
            showView('chatView');
            await startOrLoadConversation(contact.address);

            if (currentConversation) {
                await sendPresence(currentConversation, 'online');
            }
            saveContacts();
        }

        async function listenForIncomingMessages() {
            if (!chatwalletxmtp) return;

            stream = await chatwalletxmtp.conversations.streamAllMessages({
                onValue: async (message) => {
                    const isChatOpen = chatView.classList.contains('active') &&
                        currentConversation &&
                        currentConversation.id === message.conversationId;

                    const isSentByMe = message.senderInboxId === chatwalletxmtp.inboxId;

                    if (message.contentType.sameAs(ContentTypePresence)) {
                        if (isSentByMe) return; // Don't process our own presence messages

                        const presenceData = message.content;
                        if (!presenceData) return; // Safety check
                        const senderAddress = (await chatwalletxmtp.preferences.inboxStateFromInboxIds([message.senderInboxId], true))[0].identifiers[0].identifier;

                        const contactIndex = contacts.findIndex(c => c.address.toLowerCase() === senderAddress.toLowerCase());
                        if (contactIndex > -1) {
                            contacts[contactIndex].status = presenceData.status;
                            contacts[contactIndex].lastSeen = presenceData.timestamp;
                            saveContacts();

                            if (isChatOpen && currentConversation.peerAddress.toLowerCase() === senderAddress.toLowerCase()) {
                                updateChatHeaderStatus(contacts[contactIndex]);
                            }
                        }
                        return; // Stop processing after handling presence
                    }

                    // --- Handle regular messages ---
                    const type = isSentByMe ? 'sent' : 'received';

                    if (isChatOpen) {
                        addMessageToUI(message, type);
                        if (!isSentByMe) {
                            currentConversation.send({ messageId: message.id }, { contentType: window.ReadReceiptCodec.contentType });
                        }
                    }

                    const messageTimestamp = message.sentAt ? message.sentAt.getTime() : new Date().getTime();
                    let contactAddress;

                    if (isSentByMe) {
                        if (currentConversation && message.conversationId === currentConversation.id) {
                            contactAddress = currentConversation.peerAddress;
                        }
                    } else {
                        contactAddress = (await chatwalletxmtp.preferences.inboxStateFromInboxIds([message.senderInboxId], true))[0].identifiers[0].identifier;
                    }

                    if (contactAddress) {
                        const contactIndex = contacts.findIndex(c => c.address.toLowerCase() === contactAddress.toLowerCase());
                        if (contactIndex > -1) {
                            contacts[contactIndex].lastMessage = message.content;
                            contacts[contactIndex].lastMessageTimestamp = messageTimestamp;
                            if (!isSentByMe && !isChatOpen) {
                                contacts[contactIndex].unreadCount = (contacts[contactIndex].unreadCount || 0) + 1;
                            }
                        } else if (!isSentByMe) {
                            const shortAddress = `${contactAddress.slice(0, 6)}...${contactAddress.slice(-4)}`;
                            contacts.push({
                                name: shortAddress,
                                address: contactAddress,
                                unreadCount: 1,
                                lastMessage: message.content,
                                lastMessageTimestamp: messageTimestamp,
                                status: 'offline',
                                lastSeen: null
                            });
                        }
                    }

                    if (!isSentByMe) {
                        if (!isChatOpen) {
                            showNotification(message);
                        }
                        playNewMessageSound();
                    }

                    saveContacts();
                },
                onError: (error) => console.error("Error en stream de mensajes:", error)
            });
        }

        async function startOrLoadConversation(recipientAddress) {
            if (!chatwalletxmtp) { return; }

            if (!isAddress(recipientAddress)) {
                console.warn('not an eth address, trying to resolve from inboxId');
                try {
                    const newConversation = await chatwalletxmtp.conversations.newDm(recipientAddress);
                    currentConversation = newConversation;
                    await loadAndStreamMessages(currentConversation);
                } catch (e) {
                    statusEl.textContent = `Error: No se pudo iniciar la conversación.`;
                    console.error(e);
                    currentConversation = null;
                    messagesContainer.innerHTML = '';
                }
                return;
            }
            else {
                try {
                    const newConversation = await chatwalletxmtp.conversations.newDmWithIdentifier({
                        identifier: recipientAddress.toLowerCase(),
                        identifierKind: "Ethereum",
                    });
                    currentConversation = newConversation;
                    currentConversation.peerAddress = recipientAddress;
                    await loadAndStreamMessages(currentConversation);
                } catch (e) {
                    statusEl.textContent = `Error: No se pudo iniciar la conversación. ¿Está la dirección en la red?`;
                    console.error(e);
                    currentConversation = null;
                    messagesContainer.innerHTML = '';
                }
            }
        }

        async function loadAndStreamMessages(conv) {
            if (!conv) return;
            messagesContainer.innerHTML = '<p class="text-center text-gray-500">Cargando mensajes...</p>';
            processedMessages.clear();

            try {
                const existingMessages = await conv.messages();
                messagesContainer.innerHTML = '';

                for (const message of existingMessages) {
                    if (message.contentType.sameAs(ContentTypePresence)) continue; // Don't show presence messages in chat log
                    const type = message.senderInboxId === chatwalletxmtp.inboxId ? 'sent' : 'received';
                    addMessageToUI(message, type);
                }
            } catch (error) {
                console.error("Error al cargar mensajes:", error);
                messagesContainer.innerHTML = `<p class="text-center text-red-400">Error al cargar: ${error.message}`;
            }
        }

        function isHandshakeMessage(content) {
            try {
                const data = JSON.parse(content);
                return data && typeof data.initiatedByInboxId === 'string' && Array.isArray(data.addedInboxes);
            } catch (e) {
                return false;
            }
        }
        function addMessageToUI(message, type) {
            if (processedMessages.has(message.id)) return;
            processedMessages.add(message.id);

            let messageContent = typeof message.content === 'object' ? JSON.stringify(message.content) : message.content;

            const messageRow = document.createElement('div');
            messageRow.id = `msg-${message.id}`;
            

            if (messageContent.startsWith('[TRANSACTION]')) {
                messageRow.className = `w-full flex ${type === 'sent' ? 'justify-end' : 'justify-start'}`;
                try {
                    const txData = JSON.parse(messageContent.replace('[TRANSACTION]', ''));
                    const txCard = createTransactionCard(txData, type);
                    messageRow.innerHTML = txCard;
                    messagesContainer.appendChild(messageRow);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    return;
                } catch (error) {
                    console.error("No se pudo parsear el mensaje de transacción", error);
                }
            } else if (isHandshakeMessage(messageContent)) {
                 messageRow.className = 'handshake-message';
                 const handshakeData = JSON.parse(messageContent);
                 const initiator = handshakeData.initiatedByInboxId.substring(0, 10);
                 const added = handshakeData.addedInboxes.map(inbox => inbox.inboxId.substring(0, 10)).join(', ');
                 
                 let summary = `<span class="content">🤝 Contacto iniciado por ${initiator}`;
                 if(added) {
                    summary += ` y se agregó a ${added}`;
                 }
                 summary += `</span>`;
                 
                 messageRow.innerHTML = summary;

            } else {
                 messageRow.className = `w-full flex ${type === 'sent' ? 'justify-end' : 'justify-start'}`;
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-bubble ${type}`;

                const contentSpan = document.createElement('span');
                contentSpan.textContent = messageContent;

                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'message-metadata';
                
                const timeString = formatTimestampForContactList(message.sentAtNs)
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = timeString;
                metadataDiv.appendChild(timeSpan);

                if (type === 'sent') {
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'status-icon';
                    statusSpan.id = `status-${message.id}`;
                    statusSpan.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500">
                        <path d="M20 6L9 17l-5-5"></path>
                        <path d="M15 6l-9 9"></path>
                        </svg>
                    `;
                    metadataDiv.appendChild(statusSpan);
                }

                messageContainer.appendChild(contentSpan);
                messageContainer.appendChild(metadataDiv);
                messageRow.appendChild(messageContainer);
            }

            messagesContainer.appendChild(messageRow);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateMessageStatusToRead(messageId) {
            const statusIcon = document.querySelector(`#status-${messageId} svg`);
            if (statusIcon) {
                statusIcon.classList.remove('text-gray-500');
                statusIcon.classList.add('text-blue-400'); // Blue for read
            }
        }

        function showUserInfo(address) {
            const card = document.getElementById('userInfoCard');
            const avatar = document.getElementById('userCardAvatar');
            const nameEl = document.getElementById('userCardName');
            const addressEl = document.getElementById('userCardAddress');

            // Find contact to get the name
            const contact = contacts.find(c => c.address.toLowerCase() === address.toLowerCase());
            const name = contact ? contact.name : `${address.slice(0, 6)}...${address.slice(-4)}`;

            avatar.src = 'static/anonym.jpg'; // Placeholder
            nameEl.textContent = name;
            addressEl.textContent = address;
            
            card.style.display = 'block';
        }

        function updateWalletUI(wallet, isNewWallet) {
            addressEl.textContent = `${wallet.address.slice(0, 6)}...${wallet.address.slice(-4)}`;
            qrCodeEl.innerHTML = '';
            const baseUrl = window.location.href.split('?')[0];
            const chatUrl = `${baseUrl}?address=${wallet.address}`;
            const qrCode = new QRCodeStyling({
                width: 220, height: 220, data: chatUrl,
                dotsOptions: { color: "#4f46e5", type: "rounded" },
                backgroundOptions: { color: "#ffffff" },
                cornersSquareOptions: { type: "extra-rounded", color: "#4f46e5" },
                cornersDotOptions: { type: "dot", color: "#4f46e5" }
            });
            qrCode.append(qrCodeEl);
            privateKeyEl.innerHTML = isNewWallet
                ? `<strong class="text-red-300">Clave Privada (¡guárdala!):</strong> ${wallet.privateKey}`
                : '<span class="text-gray-500">Clave privada cargada desde memoria.</span>';

            // Update sidebar profile info
            updateUserProfile();
        }

        function resetUI() {
            addressEl.textContent = '';
            privateKeyEl.textContent = '';
            appHeader.classList.add('hidden');
            appNav.classList.add('hidden');
            showView('initView');
            currentWallet = null;
            chatwalletxmtp = null;
            currentConversation = null;

            // Asegurarse de que los botones de crear/restaurar estén visibles
            document.getElementById('initLoader').classList.add('hidden');
            document.getElementById('initActions').classList.remove('hidden');
        }

        function copyAddress() {
            if (!currentWallet) return;
            navigator.clipboard.writeText(currentWallet.address).then(() => {
                const copyIcon = document.getElementById('copyIcon');
                const checkIcon = document.getElementById('checkIcon');
                copyIcon.classList.add('hidden');
                checkIcon.classList.remove('hidden');
                setTimeout(() => {
                    copyIcon.classList.remove('hidden');
                    checkIcon.classList.add('hidden');
                }, 1500);
            }).catch(err => console.error('Error al copiar la dirección:', err));
        }

        // --- Notificaciones ---
        function hideNotification() {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationBanner.classList.add('opacity-0', '-translate-y-12');
            setTimeout(() => notificationBanner.classList.add('hidden'), 300);
        }

        async function showNotification(message) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            let senderAddress = (await chatwalletxmtp.preferences.inboxStateFromInboxIds([message.senderInboxId], true))[0].identifiers[0].identifier;
            let senderName = `${senderAddress.slice(0, 6)}...${senderAddress.slice(-4)}`;
            const contact = contacts.find(c => c.address.toLowerCase() === senderAddress.toLowerCase());
            if (contact) senderName = contact.name;
            notificationSender.textContent = `Nuevo mensaje de: ${senderName}`;
            notificationContent.textContent = message.content;
            notificationBanner.classList.remove('hidden');
            void notificationBanner.offsetWidth;
            notificationBanner.classList.remove('opacity-0', '-translate-y-12');
            notificationBanner.onclick = async () => {
                await handleScannedAddress(senderAddress);
                hideNotification();
            };
            notificationTimeout = setTimeout(hideNotification, 5000);
        }

        // --- Scanner ---
        function startScanner() {
            scannerView.classList.remove('hidden');
            scannerView.classList.add('flex');
            html5QrCodeScanner = new Html5Qrcode("qr-reader");
            html5QrCodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess, () => { }).catch(err => {
                    alert("Error al iniciar el escáner: " + err);
                    stopScanner();
                });
        }

        function stopScanner() {
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.stop().then(() => {
                    scannerView.classList.add('hidden');
                    scannerView.classList.remove('flex');
                }).catch(err => console.error("Error al detener escáner:", err));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            stopScanner();

            // Check if scanner was opened from the contact modal
            if (document.body.dataset.scannerContext === 'addContact') {
                const address = extractAddressFromData(decodedText);
                if (address) {
                    document.getElementById('contactAddress').value = address;
                } else {
                    alert("No se pudo encontrar una dirección válida en el QR.");
                }
                // Show the modal again
                addContactModal.classList.remove('hidden');
                addContactModal.classList.add('flex');
                // Reset context
                delete document.body.dataset.scannerContext;
            } else {
                await handleScannedData(decodedText);
            }
        }

        function extractAddressFromData(data) {
           try {
                // The generated QR might be just the URL string, not a full URL object.
                // Let's handle cases where 'data' is the full URL with parameters.
                const urlParams = new URLSearchParams(data.split('?')[1]);
                const addressFromUrl = urlParams.get('address');
                if (addressFromUrl && ethers.isAddress(addressFromUrl)) {
                    return addressFromUrl;
                }
           } catch (e) {
                // It might not be a URL, so we continue to other checks.
           }

           if (data.toLowerCase().startsWith('ethereum:')) {
               const address = data.split(':')[1].split('?')[0];
               if (ethers.isAddress(address)) return address;
           }

           if (ethers.isAddress(data)) {
               return data;
           }

           return null;
       }

        async function handleScannedData(data) {
           const address = extractAddressFromData(data);
           if (address) {
               await handleScannedAddress(address);
               openDirectChat(); // Show the chat interface
           } else {
               alert("QR no reconocido o no contiene una dirección válida.");
           }
        }

        async function handleScannedAddress(address) {
            if (!currentWallet) {
                statusEl.textContent = "Creando billetera para chatear...";
                const randomWallet = ethers.Wallet.createRandom();
                localStorage.setItem(WALLET_STORAGE_KEY, randomWallet.privateKey);
                await initializeWalletAndXmtp(randomWallet, true);
                // Aquí se podría agregar un recordatorio de backup más persistente.
                alert("Se ha creado una nueva billetera para ti. ¡Asegúrate de hacer una copia de seguridad de tu clave privada en la configuración!");
            }

            const existingContact = contacts.find(c => c.address.toLowerCase() === address.toLowerCase());
            if (existingContact) {
                await startChatWithContact(existingContact);
            } else {
                const newName = prompt(`Dirección escaneada:\n${address}\n\nIngresa un nombre para este nuevo contacto:`);
                if (newName) {
                    const newContact = { name: newName, address: address, unreadCount: 0, status: 'offline', lastSeen: null };
                    contacts.push(newContact);
                    saveContacts();
                    await startChatWithContact(newContact);
                }
            }
        }

        // --- Instalaciones (en Modal de Configuración) ---
        async function listInstallations() {
            if (!chatwalletxmtp) return;
            installationsList.innerHTML = '<p class="text-gray-400">Cargando...</p>';

            try {
                const inboxState = await chatwalletxmtp.preferences.inboxState();
                installationsList.innerHTML = '';
                if (inboxState.installations && inboxState.installations.length > 0) {
                    inboxState.installations.forEach(inst => {
                        const date = new Date(Number(inst.clientTimestampNs / 1000000n));
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                        item.innerHTML = `
                            <div>
                                <p class="font-mono text-xs break-all">ID: <span class="text-gray-300">${inst.id.slice(0, 12)}...</span></p>
                                <p class="text-xs text-gray-400">Instalado: <span class="text-gray-300">${date.toLocaleString()}</span></p>
                            </div>
                            <button data-id="${inst.id}" class="revoke-id-btn text-xs bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded">Revocar</button>
                        `;
                        installationsList.appendChild(item);
                    });
                } else {
                    installationsList.innerHTML = '<p class="text-gray-400">No se encontraron instalaciones.</p>';
                }
            } catch (error) {
                installationsList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }

        installationsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('revoke-id-btn')) {
                const installationId = e.target.dataset.id;
                if (confirm(`¿Estás seguro de que quieres revocar la instalación con ID: ${installationId.slice(0,12)}...?`)) {
                    try {
                        await chatwalletxmtp.revokeInstallations([installationId]);
                        alert('Instalación revocada. La lista se actualizará.');
                        await listInstallations(); // Refresh the list
                    } catch (error) {
                        console.error('Error al revocar la instalación:', error);
                        alert(`Error al revocar: ${error.message}`);
                    }
                }
            }
        });
        async function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const addressFromUrl = urlParams.get('address');
            if (addressFromUrl && ethers.isAddress(addressFromUrl)) {
                window.history.replaceState({}, document.title, window.location.pathname);
                await handleScannedAddress(addressFromUrl);
            }
        }

        function createTransactionCard(txData, type) {
            const network = txData.network || optionsList.find(opt => opt.TOKEN_CHAINID == txData.chainId) || optionsList[0];
            const isRequest = txData.type === 'request';
            const isSentByMe = type === 'sent';

            let title, amountColor, icon, actionButtonHTML = '';
            const explorerUrl = txData.txHash ? `${network.EXPLORER}tx/${txData.txHash}` : '#';
            const explorerLink = txData.txHash ? `<a href="${explorerUrl}" target="_blank" class="text-xs text-indigo-400 hover:underline mt-2 inline-block">Ver en explorador</a>` : '';

            // Lógica para añadir red si no existe
            let addNetworkButtonHTML = '';
            if (!isSentByMe && txData.network) {
                const networkExists = optionsList.some(net => 
                    net.TOKEN_CHAINID === txData.network.TOKEN_CHAINID && 
                    net.TOKEN_ADDRESS === txData.network.TOKEN_ADDRESS
                );
                if (!networkExists) {
                    const networkData = JSON.stringify(txData.network).replace(/"/g, '&quot;');
                    addNetworkButtonHTML = `<button onclick='addSharedNetwork(${networkData})' class="mt-3 w-full text-sm bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">Añadir red "${txData.network.TOKEN_CHAIN_NAME}"</button>`;
                }
            }

            if (isRequest) {
                title = isSentByMe ? `Solicitaste un pago` : `Te solicitaron un pago`;
                amountColor = "text-white";
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-400"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>`;
                if (!isSentByMe) {
                    actionButtonHTML = `<button onclick="handlePayRequest('${txData.amount}')" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition">Pagar ${txData.amount} ${network.TOKEN_SYMBOL || network.NATIVE_SYMBOL}</button>`;
                }
            } else {
                title = isSentByMe ? `Enviaste` : `Recibiste`;
                amountColor = isSentByMe ? "text-red-400" : "text-green-400";
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ${amountColor}"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`;
            }

            return `
                <div class="max-w-xs w-full p-4 rounded-2xl ${isSentByMe ? 'bg-indigo-900/50' : 'bg-gray-700'} border border-gray-600/50">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">${icon}</div>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-200">${title}</p>
                            <p class="text-2xl font-bold ${amountColor}">${txData.amount} <span class="text-lg text-gray-400">${network.TOKEN_SYMBOL || network.NATIVE_SYMBOL}</span></p>
                        </div>
                    </div>
                    <div class="mt-2 text-left">${explorerLink}</div>
                    ${addNetworkButtonHTML}
                    ${actionButtonHTML}
                </div>
            `;
        }

        async function handlePayRequest(amountToPay) {
            if (!currentConversation || !currentConversation.peerAddress) {
                alert("Error: No se puede determinar a quién pagar.");
                return;
            }

            await updateBalance();
            setTxStatus(`Pagar solicitud de ${amountToPay} ETH.`, false);
            sendForm.reset();
            document.getElementById('recipientAddress').value = currentConversation.peerAddress;
            document.getElementById('amount').value = amountToPay;
            sendModal.classList.remove('hidden');
            sendModal.classList.add('flex');

            isSendingFromChat = true;
            chatRecipientAddress = currentConversation.peerAddress;
        }

        async function sendMessageWithOptimisticUI(conversation, messageText) {
            try {
                conversation.sendOptimistic(messageText);
                await conversation.publishMessages();
                return true;
            } catch (error) {
                console.error('Failed to send message:', error);
                return false;
            }
        }

        // --- INICIO: LÓGICA DE BOTONES DE ACCIÓN EN HEADER DE CHAT ---
        const headerSendBtn = document.getElementById('headerSendBtn');
        const headerRequestBtn = document.getElementById('headerRequestBtn');

        headerSendBtn.addEventListener('click', async () => {
            if (!currentConversation || !currentConversation.peerAddress) {
                alert("No se pudo obtener la dirección del destinatario del chat actual.");
                return;
            }

            isSendingFromChat = true;
            chatRecipientAddress = currentConversation.peerAddress;

            await updateBalance();
            setTxStatus('Enviar a tu contacto de chat.', false);
            sendForm.reset();
            
            recipientAddressInput.value = chatRecipientAddress;
            recipientAddressInput.readOnly = true; // Bloquear el campo

            sendModal.classList.remove('hidden');
            sendModal.classList.add('flex');
            amountInput.focus(); // Poner el foco en el monto
        });

        headerRequestBtn.addEventListener('click', async () => {
            const amount = prompt("¿Qué monto en ETH deseas solicitar?", "0.01");
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const messageText = `[TRANSACTION]${JSON.stringify({ type: 'request', amount: parseFloat(amount), chainId: optionsList[currentTokenIndex].TOKEN_CHAINID })}`;
                if (currentConversation) {
                    try {
                        await currentConversation.send(messageText);
                        // La actualización de la UI se maneja en el listener de mensajes
                    } catch (error) {
                        console.error("Error al enviar solicitud:", error);
                        alert("No se pudo enviar la solicitud.");
                    }
                }
            } else if (amount !== null) {
                alert("Por favor, ingresa un monto válido.");
            }
        });

        // --- FIN: LÓGICA DE BOTONES DE ACCIÓN EN HEADER DE CHAT ---

        // --- INICIO: GESTIÓN DE REDES ---
        async function loadAllChainsData() {
            if (allChainsData.length > 0) return;
            try {
                const response = await fetch("chainsv1.json");
                if (!response.ok) {
                    console.warn("Could not fetch chainsv1.json. Autocomplete will be disabled.");
                    return;
                }
                allChainsData = await response.json();
            } catch (error) {
                console.error("Error fetching or parsing chainsv1.json:", error);
                allChainsData = [];
            }
        }

        function handleAutocomplete(e) {
            if (allChainsData.length === 0) return;

            const input = e.target;
            const value = input.value.trim();
            let foundChain = null;

            if (input.id === 'networkChainId') {
                if (!isNaN(value) && value !== '') {
                    foundChain = allChainsData.find(chain => chain.chainId === parseInt(value));
                }
            } else if (input.id === 'networkName') {
                if (value.length > 2) {
                    foundChain = allChainsData.find(chain => chain.name.toLowerCase().includes(value.toLowerCase()));
                }
            }

            if (foundChain) {
                networkNameInput.value = foundChain.name || '';
                networkChainIdInput.value = foundChain.chainId || '';

                const rpc = foundChain.rpc?.find(url => url && !url.includes('${') && !url.startsWith('ws')) || foundChain.rpc?.[0] || '';
                networkRpcUrlInput.value = rpc;

                const explorer = foundChain.explorers?.[0]?.url || '';
                networkExplorerUrlInput.value = explorer;

                const nativeSymbol = foundChain.nativeCurrency?.symbol || '';
                document.getElementById('nativeSymbol').value = nativeSymbol;
            }
        }

        function saveNetworks() {
            localStorage.setItem(NETWORKS_STORAGE_KEY, JSON.stringify(optionsList));
        }

        function loadNetworks() {
            const storedNetworks = localStorage.getItem(NETWORKS_STORAGE_KEY);
            let customNetworks = [];

            if (storedNetworks) {
                const allStored = JSON.parse(storedNetworks);
                // Filtra solo las redes que no son por defecto para mantener las personalizadas
                customNetworks = allStored.filter(storedNet => 
                    !defaultNetworks.some(defaultNet => 
                        defaultNet.TOKEN_CHAINID === storedNet.TOKEN_CHAINID && 
                        defaultNet.TOKEN_CHAIN_NAME === storedNet.TOKEN_CHAIN_NAME
                    )
                );
            }

            // Combina las redes por defecto del código con las personalizadas del usuario
            optionsList = [...defaultNetworks, ...customNetworks];
            saveNetworks(); // Guarda la lista fusionada

            // Ensure isFavorite property exists
            optionsList.forEach(net => {
                if (net.isFavorite === undefined) {
                    net.isFavorite = false;
                }
            });
        }

        function isDefaultNetwork(network) {
            return defaultNetworks.some(d => d.TOKEN_CHAINID === network.TOKEN_CHAINID && d.TOKEN_CHAIN_NAME === network.TOKEN_CHAIN_NAME);
        }

        function getSortedNetworks() {
            const indexedList = optionsList.map((net, index) => ({ ...net, originalIndex: index }));

            indexedList.sort((a, b) => {
                if (a.isFavorite && !b.isFavorite) return -1;
                if (!a.isFavorite && b.isFavorite) return 1;

                const aIsDefault = isDefaultNetwork(a);
                const bIsDefault = isDefaultNetwork(b);

                if (aIsDefault && !bIsDefault) return -1;
                if (!aIsDefault && bIsDefault) return 1;

                return a.TOKEN_CHAIN_NAME.localeCompare(b.TOKEN_CHAIN_NAME);
            });

            return indexedList;
        }


        function renderNetworksList() {
            const sortedNetworks = getSortedNetworks();
            networksListContainer.innerHTML = '';

            let favoritesRendered = false;
            let defaultsRendered = false;
            let customRendered = false;

            sortedNetworks.forEach((network) => {
                let sectionHeader = null;
                if (network.isFavorite && !favoritesRendered) {
                    sectionHeader = "Favoritos";
                    favoritesRendered = true;
                } else if (isDefaultNetwork(network) && !network.isFavorite && !defaultsRendered) {
                    sectionHeader = "Redes por Defecto";
                    defaultsRendered = true;
                } else if (!isDefaultNetwork(network) && !network.isFavorite && !customRendered) {
                    sectionHeader = "Mis Redes";
                    customRendered = true;
                }

                if (sectionHeader) {
                    const header = document.createElement('h4');
                    header.className = 'text-xs font-bold text-gray-400 pt-3 px-1';
                    header.textContent = sectionHeader;
                    networksListContainer.appendChild(header);
                }

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                const isFav = network.isFavorite;

                const starSVG = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${isFav ? '#facc15' : 'none'}" stroke="${isFav ? '#facc15' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                `;

                item.innerHTML = `
                    <div data-index="${network.originalIndex}" class="edit-network-trigger flex items-center space-x-2 flex-grow cursor-pointer">
                         <button data-index="${network.originalIndex}" class="favorite-network-btn text-gray-500 hover:text-yellow-400 p-1">
                            ${starSVG}
                         </button>
                        <div>
                            <p class="font-semibold text-sm">${network.TOKEN_CHAIN_NAME}</p>
                            <p class="text-xs text-gray-400">Chain ID: ${network.TOKEN_CHAINID}</p>
                        </div>
                    </div>
                    ${!isDefaultNetwork(network) ? `<button data-index="${network.originalIndex}" class="delete-network-btn text-xs bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded flex-shrink-0">Eliminar</button>` : '<span class="text-xs text-gray-500 pr-2 flex-shrink-0">Default</span>'}
                `;
                networksListContainer.appendChild(item);
            });
    
            document.querySelectorAll('.delete-network-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteNetwork);
            });
            document.querySelectorAll('.favorite-network-btn').forEach(btn => {
                btn.addEventListener('click', toggleFavorite);
            });
            document.querySelectorAll('.edit-network-trigger').forEach(trigger => {
                trigger.addEventListener('click', handleEditNetworkTrigger);
            });
        }

        function handleAddNewNetwork(e) {
            e.preventDefault();
            const name = document.getElementById('networkName').value.trim();
            const chainId = document.getElementById('networkChainId').value.trim();
            const rpcUrl = document.getElementById('networkRpcUrl').value.trim();
            const explorerUrl = document.getElementById('networkExplorerUrl').value.trim();
            const nativeSymbol = document.getElementById('nativeSymbol').value.trim();
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            const tokenSymbol = document.getElementById('tokenSymbol').value.trim();
            const editIndex = parseInt(document.getElementById('editNetworkIndex').value, 10);

            if (!name || !chainId || !rpcUrl || !nativeSymbol) {
                alert("Por favor, completa los campos de red obligatorios (Nombre, Chain ID, RPC, Símbolo Nativo).");
                return;
            }

            // Validación de URL del RPC
            try {
                new URL(rpcUrl);
            } catch (_) {
                alert("La URL del RPC no es válida. Asegúrate de que incluya http:// o https://");
                return;
            }

            const newNetwork = {
                "TOKEN_CHAIN_NAME": name,
                "TOKEN_CHAINID": chainId,
                "EXPLORER": explorerUrl || '',
                "API": rpcUrl,
                "NATIVE_SYMBOL": nativeSymbol,
                "TOKEN_ADDRESS": (tokenAddress && ethers.isAddress(tokenAddress)) ? tokenAddress : null,
                "TOKEN_SYMBOL": (tokenAddress && tokenSymbol) ? tokenSymbol : null,
                "isFavorite": false
            };
    
            if (editIndex > -1) {
                // Modo Edición: Actualizar la red existente
                optionsList[editIndex] = { ...optionsList[editIndex], ...newNetwork };
            } else {
                // Modo Añadir: Añadir nueva red
                optionsList.push(newNetwork);
            }

            saveNetworks();
            renderNetworksList();
            addNetworkForm.reset();
            closeAddNetworkModal();
        }

        function handleDeleteNetwork(e) {
            e.stopPropagation();
            const indexToDelete = parseInt(e.currentTarget.dataset.index, 10);
            if (confirm(`¿Estás seguro de que quieres eliminar la red "${optionsList[indexToDelete].TOKEN_CHAIN_NAME}"?`)) {

                let selectedNetworkIdentifier = optionsList[currentTokenIndex].TOKEN_CHAINID + optionsList[currentTokenIndex].TOKEN_CHAIN_NAME;

                optionsList.splice(indexToDelete, 1);

                // After deleting, find the new index of the previously selected network
                let newSelectedIndex = optionsList.findIndex(net => (net.TOKEN_CHAINID + net.TOKEN_CHAIN_NAME) === selectedNetworkIdentifier);

                // If the selected network was deleted, default to 0
                if (newSelectedIndex === -1) {
                    newSelectedIndex = 0;
                }

                currentTokenIndex = newSelectedIndex;
                localStorage.setItem(SELECTED_NETWORK_KEY, currentTokenIndex.toString());

                saveNetworks();
                renderNetworksList();
            }
        }

        function toggleFavorite(e) {
            e.stopPropagation();
            const indexToToggle = parseInt(e.currentTarget.dataset.index, 10);
            optionsList[indexToToggle].isFavorite = !optionsList[indexToToggle].isFavorite;
            saveNetworks();
            renderNetworksList();
            renderTokenMenu();
        }

        function handleEditNetworkTrigger(e) {
            // Evita que el evento se propague a los botones internos
            if (e.target.closest('button')) return;
            
            const indexToEdit = parseInt(e.currentTarget.dataset.index, 10);
            openEditNetworkModal(indexToEdit);
        }

        function openEditNetworkModal(index) {
            const network = optionsList[index];
            if (!network) return;

            document.getElementById('networkModalTitle').textContent = "Editar Red";
            document.getElementById('editNetworkIndex').value = index;

            document.getElementById('networkName').value = network.TOKEN_CHAIN_NAME || '';
            document.getElementById('networkChainId').value = network.TOKEN_CHAINID || '';
            document.getElementById('networkRpcUrl').value = network.API || '';
            document.getElementById('networkExplorerUrl').value = network.EXPLORER || '';
            document.getElementById('nativeSymbol').value = network.NATIVE_SYMBOL || '';
            document.getElementById('tokenAddress').value = network.TOKEN_ADDRESS || '';
            document.getElementById('tokenSymbol').value = network.TOKEN_SYMBOL || '';

            // Abre el modal de "Añadir/Editar"
            addNewNetworkModal.classList.remove('hidden');
            addNewNetworkModal.classList.add('flex');
        }

        function addSharedNetwork(networkData) {
            if (!networkData || !networkData.TOKEN_CHAINID) return;
            const networkExists = optionsList.some(net => 
                net.TOKEN_CHAINID === networkData.TOKEN_CHAINID && 
                net.TOKEN_ADDRESS === networkData.TOKEN_ADDRESS
            );
            if (networkExists) {
                alert(`La red "${networkData.TOKEN_CHAIN_NAME}" ya existe en tu billetera.`);
                return;
            }
            optionsList.push({ ...networkData, isFavorite: false });
            saveNetworks();
            alert(`¡La red "${networkData.TOKEN_CHAIN_NAME}" ha sido añadida! Puedes gestionarla en la configuración.`);
        }
        function openManageNetworksModal() {
            loadAllChainsData();
            renderNetworksList();
            manageNetworksModal.classList.remove('hidden');
            manageNetworksModal.classList.add('flex');
        }

        function closeManageNetworksModal() {
            manageNetworksModal.classList.add('hidden');
            manageNetworksModal.classList.remove('flex');
            renderTokenMenu(); // Refresh main menu in case favorites changed
        }

        function openAddNetworkModal() {
            addNewNetworkModal.classList.remove('hidden');
            addNewNetworkModal.classList.add('flex');
            document.getElementById('networkModalTitle').textContent = "Añadir Nueva Red";
            document.getElementById('editNetworkIndex').value = "-1";
            addNetworkForm.reset();
        }

        function closeAddNetworkModal() {
            addNewNetworkModal.classList.add('hidden');
            addNewNetworkModal.classList.remove('flex');
        }

        // --- FIN: GESTIÓN DE REDES ---

        // --- INICIO: PRESENCIA Y RECIBOS DE LECTURA (Refactored) ---
        const ContentTypePresence = {
            authorityId: "xmtp.chatwallet",
            typeId: "presence",
            versionMajor: 1,
            versionMinor: 0,
        };

        class PresenceCodec {
            get contentType() {
                return ContentTypePresence;
            }

            encode(content) {
                return {
                    type: ContentTypePresence,
                    parameters: {},
                    content: new TextEncoder().encode(JSON.stringify(content)),
                };
            }

            decode(encodedContent) {
                const uint8Array = encodedContent.content;
                const jsonStr = new TextDecoder().decode(uint8Array);
                return JSON.parse(jsonStr);
            }

            fallback(content) {
                return `[Presence Update: ${content.status}]`;
            }
        }

        async function sendPresence(conversation, status) {
            if (!conversation) return;
            const presenceData = { status, timestamp: Date.now() };
            try {
                await conversation.send(presenceData, { contentType: ContentTypePresence });
            } catch (e) {
                console.error("Failed to send presence", e);
            }
        }

        function updateChatHeaderStatus(contact) {
            if (!contact) {
                chatStatusIndicator.textContent = '';
                return;
            }
            if (contact.status === 'online') {
                chatStatusIndicator.textContent = '🟢 En línea';
            } else if (contact.lastSeen) {
                const minutesAgo = Math.floor((Date.now() - contact.lastSeen) / 60000);
                if (minutesAgo < 1) {
                    chatStatusIndicator.textContent = '⚪️ Últ. vez hace un momento';
                } else {
                    chatStatusIndicator.textContent = `⚪️ Últ. vez hace ${minutesAgo} min`;
                }
            } else {
                chatStatusIndicator.textContent = '⚪️ Desconectado';
            }
        }
        // --- FIN: PRESENCIA Y RECIBOS DE LECTURA ---


        // --- Event Listeners ---
        createWalletButton.addEventListener('click', async () => {
            statusEl.textContent = "Creando billetera...";
            createWalletButton.disabled = true;
            const randomWallet = ethers.Wallet.createRandom();
            localStorage.setItem(WALLET_STORAGE_KEY, randomWallet.privateKey);
            await initializeWalletAndXmtp(randomWallet, true);
            createWalletButton.disabled = false;
        });

        restoreWalletButton.addEventListener('click', () => {
            restoreWalletModal.classList.remove('hidden');
            restoreWalletModal.classList.add('flex');
            restoreError.textContent = '';
            restoreWalletForm.reset();
            setRestoreMode('privateKey');
        });

        cancelRestoreWallet.addEventListener('click', () => restoreWalletModal.classList.add('hidden'));
        restoreModePrivateKeyBtn.addEventListener('click', () => setRestoreMode('privateKey'));
        restoreModeMnemonicBtn.addEventListener('click', () => setRestoreMode('mnemonic'));
        restoreWalletForm.addEventListener('submit', handleRestoreWallet);

        forgetWalletButton.addEventListener('click', () => {
            if (confirm("¿Estás seguro? Perderás el acceso a esta billetera si no has guardado la clave privada.")) {
                localStorage.removeItem(WALLET_STORAGE_KEY);
                localStorage.removeItem(NETWORKS_STORAGE_KEY);
                localStorage.removeItem(SELECTED_NETWORK_KEY);
                resetUI();
                statusEl.textContent = "Billetera olvidada. Crea una nueva.";
                settingsModal.classList.add('hidden');
            }
        });

        copyAddressButton.addEventListener('click', copyAddress);
        backToContactsBtn.addEventListener('click', () => {
            // Close chat view and show wallet view, also open sidebar
            showView('walletView');
            openSidebar();
        });

        document.getElementById('chatHeaderInfo').addEventListener('click', () => {
            if (currentConversation && currentConversation.peerAddress) {
                showUserInfo(currentConversation.peerAddress);
            }
        });

        document.getElementById('closeUserCard').addEventListener('click', () => {
            document.getElementById('userInfoCard').style.display = 'none';
        });

        scanQrBtn.addEventListener('click', startScanner);
        // The original closeScannerBtn listener is now overridden further down
        // to handle the modal context correctly.
        closeNotification.addEventListener('click', (e) => { e.stopPropagation(); hideNotification(); });

        sendMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (!messageText || !currentConversation) return;

            const submitButton = e.target.querySelector('button[type="submit"]');
            messageInput.disabled = true;
            submitButton.disabled = true;

            try {
                const sentMessage = await currentConversation.send(messageText);

                const contactIndex = contacts.findIndex(c => c.address.toLowerCase() === currentConversation.peerAddress.toLowerCase());
                if (contactIndex > -1) {
                    contacts[contactIndex].lastMessage = messageText;
                    contacts[contactIndex].lastMessageTimestamp = Date.now();
                    saveContacts();
                }

                messageInput.value = '';
            } catch (error) {
                console.error("Error al enviar mensaje:", error);
                statusEl.textContent = `Error al enviar: ${error.message}`;
            } finally {
                messageInput.disabled = false;
                submitButton.disabled = false;
                messageInput.focus();
            }
        });

        // Modals
        if (addContactBtn) {
            addContactBtn.addEventListener('click', openAddContactModal);
        }
        addContactBtnSidebar.addEventListener('click', openAddContactModal);
        cancelAddContact.addEventListener('click', closeContactModal);

        document.getElementById('scanForContactAddressBtn').addEventListener('click', () => {
           // Set a context to know where to put the result
           document.body.dataset.scannerContext = 'addContact';
           // Hide the modal so the scanner can be seen
           addContactModal.classList.remove('flex');
           addContactModal.classList.add('hidden');
           startScanner();
        });

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
            listInstallations();
        });
        closeSettingsModal.addEventListener('click', () => settingsModal.classList.add('hidden'));

        backupWalletSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden'); // Ocultar modal de configuración
            openBackupModal(); // Abrir modal de copia de seguridad
        });
        
        sendBtn.addEventListener('click', async () => {
            await updateBalance();
            setTxStatus('Introduce los detalles de la transacción.', false);
            sendForm.reset();
            sendModal.classList.remove('hidden');
            sendModal.classList.add('flex');
            recipientAddressInput.readOnly = false; // Asegurarse de que no esté bloqueado
        });
        cancelSendBtn.addEventListener('click', () => {
            sendModal.classList.add('hidden');
            recipientAddressInput.readOnly = false; // Desbloquear al cancelar
            sendModal.classList.remove('flex');
        });
        sendForm.addEventListener('submit', handleSendTransaction);

        tokenSelectorToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            renderTokenMenu();
            tokenSelectorMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!tokenSelectorMenu.classList.contains('hidden') && !tokenSelectorMenu.contains(e.target)) {
                tokenSelectorMenu.classList.add('hidden');
            }
        });

        chatActionsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = chatActionsContainer.classList.toggle('hidden');
            chatActionsToggle.querySelector('svg').style.transform = isHidden ? 'rotate(0deg)' : 'rotate(45deg)';
        });

        document.addEventListener('click', (e) => {
            if (!chatActionsContainer.classList.contains('hidden') && !chatActionsContainer.contains(e.target)) {
                chatActionsContainer.classList.add('hidden');
                chatActionsToggle.querySelector('svg').style.transform = 'rotate(0deg)';
            }
        });

        chatSendCryptoBtn.addEventListener('click', async () => {
            if (!currentConversation || !currentConversation.peerAddress) {
                alert("No se pudo obtener la dirección del destinatario del chat actual.");
                return;
            }

            isSendingFromChat = true;
            chatRecipientAddress = currentConversation.peerAddress;

            await updateBalance();
            setTxStatus('Enviar a tu contacto de chat.', false);
            sendForm.reset();
            document.getElementById('recipientAddress').value = chatRecipientAddress;
            sendModal.classList.remove('hidden');
            sendModal.classList.add('flex');

            chatActionsContainer.classList.add('hidden');
            chatActionsToggle.querySelector('svg').style.transform = 'rotate(0deg)';
        });

        chatRequestCryptoBtn.addEventListener('click', async () => {
            chatActionsContainer.classList.add('hidden');
            chatActionsToggle.querySelector('svg').style.transform = 'rotate(0deg)';

            const amount = prompt("¿Qué monto en ETH deseas solicitar?", "0.01");
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const messageText = `[TRANSACTION]${JSON.stringify({ type: 'request', amount: parseFloat(amount), chainId: optionsList[currentTokenIndex].TOKEN_CHAINID })}`;
                if (currentConversation) {
                    try {
                        const sentMessage = await currentConversation.send(messageText);
                        const contactIndex = contacts.findIndex(c => c.address.toLowerCase() === currentConversation.peerAddress.toLowerCase());
                        if (contactIndex > -1) {
                            contacts[contactIndex].lastMessage = messageText;
                            contacts[contactIndex].lastMessageTimestamp = Date.now();
                            saveContacts();
                        }
                    } catch (error) {
                        console.error("Error al enviar solicitud:", error);
                        alert("No se pudo enviar la solicitud.");
                    }
                }
            } else if (amount !== null) {
                alert("Por favor, ingresa un monto válido.");
            }
        });

        // Contact Import/Export
        if (importContactsBtn) {
            importContactsBtn.addEventListener('click', () => importContactsInput.click());
        }
        if (importContactsInput) {
            importContactsInput.addEventListener('change', handleImportContacts);
        }
        if (exportContactsBtn) {
            exportContactsBtn.addEventListener('click', exportContacts);
        }

        // Network Management Listeners
        manageNetworksBtn.addEventListener('click', openManageNetworksModal);
        closeManageNetworksModalBtn.addEventListener('click', closeManageNetworksModal);
        openAddNetworkModalBtn.addEventListener('click', openAddNetworkModal);
        closeAddNetworkModalBtn.addEventListener('click', closeAddNetworkModal);
        addNetworkForm.addEventListener('submit', handleAddNewNetwork);
        networkChainIdInput.addEventListener('input', handleAutocomplete);
        networkNameInput.addEventListener('input', handleAutocomplete);

        // Sidebar Event Listeners
        burgerMenuBtn.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            if (contactsSidebar.classList.contains('active') &&
                !contactsSidebar.contains(e.target) &&
                !burgerMenuBtn.contains(e.target)) {
                closeSidebar();
            }
        });

        document.body.addEventListener('dblclick', toggleFullscreen);

        // --- Interactive Sidebar Drag ---
        document.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            touchStartX = touch.clientX;

            // If sidebar is active, prepare for a potential drag-to-close
            if (contactsSidebar.classList.contains('active')) {
                isDragging = true;
                // Remove transition to allow for 1:1 drag movement
                contactsSidebar.style.transition = 'none';
            }
        }, { passive: true });

        document.addEventListener('touchmove', e => {
            if (!isDragging) return; // Only run if we started dragging on the active sidebar

            touchCurrentX = e.touches[0].clientX;
            const deltaX = touchCurrentX - touchStartX;
            const sidebarWidth = contactsSidebar.offsetWidth;

            // We are only handling drag-to-close here.
            // The transform is calculated based on how far right you've dragged.
            const newTransform = Math.min(Math.max(0, deltaX), sidebarWidth);
            contactsSidebar.style.transform = `translateX(${newTransform}px)`;

        }, { passive: true });

        document.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].clientX;

            // --- Handle Swipe to Open ---
            if (!isDragging && touchStartX - touchEndX > 50 && !contactsSidebar.classList.contains('active')) {
                openSidebar();
                return; // Stop further execution
            }
            
            // --- Handle Drag to Close ---
            if (!isDragging) return;
            isDragging = false;

            const sidebarWidth = contactsSidebar.offsetWidth;
            const dragDistance = touchCurrentX - touchStartX;

            // Restore transition for smooth animation
            contactsSidebar.style.transition = 'transform 0.3s ease';

            // If dragged more than 1/3 of the way, complete the close
            if (dragDistance > sidebarWidth / 3) {
                closeSidebar();
            } else {
                // Otherwise, snap back to open
                contactsSidebar.style.transform = 'translateX(0px)';
            }
            
            // Clean up inline styles after transition ends
             setTimeout(() => {
                // Only clear if the user hasn't started a new drag
                if (!isDragging) {
                   contactsSidebar.style.transition = '';
                   contactsSidebar.style.transform = '';
                }
            }, 300);
        });

       closeScannerBtn.addEventListener('click', () => {
           stopScanner();
           if (document.body.dataset.scannerContext === 'addContact') {
               addContactModal.classList.remove('hidden');
               addContactModal.classList.add('flex');
               delete document.body.dataset.scannerContext;
           }
       });

        window.addEventListener('beforeunload', () => {
            if (currentConversation) {
                sendPresence(currentConversation, 'offline');
            }
        });

        // --- INICIO: LÓGICA DE COPIA DE SEGURIDAD (Global Scope) ---
        const backupNowBtn = document.getElementById('backupNowBtn');
        const backupWalletModal = document.getElementById('backupWalletModal');
        const showBackupKeysBtn = document.getElementById('showBackupKeysBtn');
        const cancelBackupBtn = document.getElementById('cancelBackupBtn');
        const closeBackupModalBtn = document.getElementById('closeBackupModalBtn');
        const closeBackupModal = document.getElementById('closeBackupModal'); // Botón 'X'

        function openBackupModal() {
            if (!currentWallet) return;

            const mnemonicContainer = document.getElementById('backupMnemonicContainer');
            const mnemonicEl = document.getElementById('backupMnemonic');
            const privateKeyEl = document.getElementById('backupPrivateKey');

            // Reset to warning view first
            document.getElementById('backupWarningView').classList.remove('hidden');
            document.getElementById('backupKeysView').classList.add('hidden');

            if (currentWallet.mnemonic && currentWallet.mnemonic.phrase) {
                mnemonicEl.textContent = currentWallet.mnemonic.phrase;
                mnemonicContainer.classList.remove('hidden');
            } else {
                mnemonicContainer.classList.add('hidden');
            }

            privateKeyEl.textContent = currentWallet.privateKey;
            backupWalletModal.classList.remove('hidden');
            backupWalletModal.classList.add('flex');
        }

        function doCloseBackupModal() {
            backupWalletModal.classList.add('hidden');
            backupWalletModal.classList.remove('flex');
            // Ocultar el recordatorio una vez que el modal se ha cerrado
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('translate-y-full');
        }

        function hideBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('translate-y-full');
        }

        function copyBackupData(elementId, button) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>', 2000);
            });
        }

        // Assign functions to window object to make them global
        window.openBackupModal = openBackupModal;
        window.closeBackupModal = closeBackupModal;
        window.copyBackupData = copyBackupData;
        window.hideBackupReminder = hideBackupReminder;
        window.addSharedNetwork = addSharedNetwork;

        // Backup Listeners
        backupNowBtn.addEventListener('click', openBackupModal);
        closeBackupModalBtn.addEventListener('click', doCloseBackupModal);
        cancelBackupBtn.addEventListener('click', doCloseBackupModal);
        closeBackupModal.addEventListener('click', doCloseBackupModal);
        showBackupKeysBtn.addEventListener('click', () => {
            document.getElementById('backupWarningView').classList.add('hidden');
            document.getElementById('backupKeysView').classList.remove('hidden');
        });
        document.getElementById('closeBackupReminderBtn').addEventListener('click', hideBackupReminder);



        // --- FIN: LÓGICA DE COPIA DE SEGURIDAD ---

        // --- Carga Inicial ---
        async function init() {
            loadNetworks();

            const savedNetworkIndex = localStorage.getItem(SELECTED_NETWORK_KEY);
            if (savedNetworkIndex && parseInt(savedNetworkIndex) < optionsList.length) {
                currentTokenIndex = parseInt(savedNetworkIndex, 10);
            }

            const savedPrivateKey = localStorage.getItem(WALLET_STORAGE_KEY);
            if (savedPrivateKey) {
                try {
                    statusEl.textContent = "Cargando billetera guardada...";
                    const savedWallet = new ethers.Wallet(savedPrivateKey);
                    await initializeWalletAndXmtp(savedWallet, false);
                } catch (e) {
                    statusEl.textContent = "No se pudo cargar la billetera. Crea o restaura una.";
                    localStorage.removeItem(WALLET_STORAGE_KEY);
                    resetUI();
                }
            } else {
                statusEl.textContent = "Crea o restaura una billetera para empezar.";
                document.getElementById('initLoader').classList.add('hidden');
                document.getElementById('initActions').classList.remove('hidden');
                resetUI();
            }
        }

        init();

        let toneJsReady = typeof Tone !== 'undefined';
        let clickSynth;
        let toneStarted = false;

        async function initToneOnce() {
            if (!toneJsReady || toneStarted) return;
            try {
                await Tone.start();
                toneStarted = true;
                localStorage.setItem('toneInitialized', 'true');

                clickSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 }
                }).toDestination();

            } catch (err) {
                console.error('No se pudo iniciar Tone.js:', err);
            }
        }

        function playNewMessageSound() {
            if (toneStarted && clickSynth) {
                const now = Tone.now();
                clickSynth.triggerAttackRelease("C4", "8n", now + 0.05);
            }
        }

        window.addEventListener('click', initToneOnce, { once: true });
        window.addEventListener('touchstart', initToneOnce, { once: true });


        // --- Configuración de Tone.js ---

        // 1. Efectos para la "magia" (espacio y ecos)
        // La reverberación simula un espacio grande (el "cielo")
        const reverb = new Tone.Reverb({
            decay: 2.5, // Cola de reverberación larga
            wet: 0.6    // Bastante efecto
        }).toDestination();

        // El delay añade el "brillo" y la repetición mágica
        const delay = new Tone.FeedbackDelay({
            delayTime: "8n", // Tiempo de eco
            feedback: 0.4,   // Cuántas veces se repite
            wet: 0.3
        }).connect(reverb); // Conectamos el delay A LA REVERB para un sonido más etéreo


        // 2. El generador de sonido (el "polvo mágico")
        // Usamos ruido rosa, que es más suave que el blanco
        const noise = new Tone.Noise("pink");

        // 3. El filtro (la "caída")
        // Usamos un filtro de paso de banda (Bandpass) para enfocar el sonido.
        // Empezará agudo y caerá a grave.
        const filter = new Tone.Filter({
            type: "bandpass",
            frequency: 4000, // Frecuencia inicial (aguda)
            Q: 5           // Resonancia para un efecto más "silbante"
        });

        // 4. El sobre de volumen (cuándo suena y cuándo se calla)
        const ampEnv = new Tone.AmplitudeEnvelope({
            attack: 0.05,
            decay: 0.8,
            sustain: 0.1,
            release: 0.5
        });

        // 5. Conectar todo el flujo de audio
        // Ruido -> Filtro -> Sobre de Volumen -> Delay -> Reverb -> Altavoces
        noise.connect(filter);
        filter.connect(ampEnv);
        ampEnv.connect(delay);

        // Encendemos el ruido (pero no sonará hasta que el ampEnv se active)
        noise.start();

        document.addEventListener('DOMContentLoaded', () => {
            const directChat = document.getElementById('direct-chat');
            const closeDirectChat = document.getElementById('close-direct-chat');
            const directChatHistory = document.getElementById('direct-chat-history');
            const directChatInput = document.getElementById('direct-chat-input');
            const directChatSend = document.getElementById('direct-chat-send');

            // Show the direct chat when a QR is scanned (this will be triggered later)
            function openDirectChat() {
                directChat.classList.remove('hidden');
            }

            closeDirectChat.addEventListener('click', () => {
                directChat.classList.add('hidden');
            });

            directChatSend.addEventListener('click', sendMessage);
            directChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const message = directChatInput.value.trim();
                if (message) {
                    // Display the message in the chat history
                    const messageElement = document.createElement('div');
                    messageElement.textContent = message;
                    directChatHistory.appendChild(messageElement);
                    directChatInput.value = '';
                    // Here you would also send the message to the peer
                }
            }
        });

        // --- Función para disparar el sonido ---

        function playMagicFall() {
            // Asegurarse de que el contexto de audio se inicie (necesario en navegadores)
            Tone.start();

            const now = Tone.now();

            // 1. Disparamos el sobre de volumen (duración total de 1.3 segundos)
            ampEnv.triggerAttackRelease("1.3", now);

            // 2. ¡LA CLAVE DE LA CAÍDA!
            // Automatizamos la frecuencia del filtro.

            // Inicia en 4000 Hz inmediatamente
            filter.frequency.setValueAtTime(4000, now);

            // Cae (rampa) hasta 100 Hz durante 1.2 segundos.
            // Usamos "exponentialRampTo" para una caída más natural.
            filter.frequency.exponentialRampTo(100, 1.2, now + 0.05);
        }
 
 
        // User DID Window Logic
        const userDidTrigger = document.getElementById('userDidTrigger');
        const userDidWindow = document.getElementById('userDidWindow');
        const closeUserDidWindow = document.getElementById('closeUserDidWindow');
        const userDidAvatar = document.getElementById('userDidAvatar');
        const avatarUpload = document.getElementById('avatarUpload');
        const userDidAliasInput = document.getElementById('userDidAlias');
        const usernameStatusEl = document.getElementById('usernameStatus');
        const contactNameInput = document.getElementById('contactName');
        const contactNameStatusEl = document.getElementById('contactNameStatus');

        // Brand Modal
        const brandTag = document.getElementById('brand-tag');
        const brandModal = document.getElementById('brandModal');
        const closeBrandModal = document.getElementById('closeBrandModal');

        brandTag.addEventListener('click', (e) => {
            e.preventDefault();
            brandModal.classList.remove('hidden');
            brandModal.classList.add('flex');
        });
        closeBrandModal.addEventListener('click', () => brandModal.classList.add('hidden'));

        // Contract Configuration
        // const CHATWALLET_DID_ADDRESS = "0x96Df83456f0B4d161C3E00278Ba33670c796523d";
        // const CHATWALLET_DID_ABI = [
        //     "function usernameToAddress(string memory) public view returns (address)"
        // ];

        let usernameCheckTimeout;

        // --- Username Check for User DID Alias ---
        userDidAliasInput.addEventListener('input', (e) => {
            const username = e.target.value.trim().toLowerCase();
            clearTimeout(usernameCheckTimeout);
            usernameStatusEl.textContent = '';
            usernameStatusEl.className = 'text-xs mt-1 min-h-[1rem]'; // Reset classes

            if (username.length < 3) {
                 if (username.length > 0) {
                    usernameStatusEl.textContent = 'Debe tener al menos 3 caracteres.';
                    usernameStatusEl.classList.add('text-gray-400');
                }
                return;
            }
             if (!/^[a-z0-9_]+$/.test(username)) {
                usernameStatusEl.textContent = 'Solo letras minúsculas, números y _';
                usernameStatusEl.className = 'text-xs mt-1 min-h-[1rem] text-red-400';
                return;
            }

            usernameStatusEl.textContent = 'Verificando disponibilidad...';
            usernameStatusEl.classList.add('text-yellow-400');

            usernameCheckTimeout = setTimeout(async () => {
                await checkUsernameAvailability(username, usernameStatusEl);
            }, 500); // Debounce 500ms
        });

        // --- Username Check for Contact Name ---
        contactNameInput.addEventListener('input', (e) => {
            const username = e.target.value.trim().toLowerCase();
            clearTimeout(usernameCheckTimeout);
            contactNameStatusEl.textContent = '';
            contactNameStatusEl.className = 'text-xs mt-1 min-h-[1rem]'; // Reset classes

            if (username.length < 3) {
                if (username.length > 0) {
                    contactNameStatusEl.textContent = 'Debe tener al menos 3 caracteres.';
                    contactNameStatusEl.classList.add('text-gray-400');
                }
                return;
            }
             if (!/^[a-z0-9_]+$/.test(username)) {
                contactNameStatusEl.textContent = 'Solo letras minúsculas, números y _';
                contactNameStatusEl.className = 'text-xs mt-1 min-h-[1rem] text-red-400';
                return;
            }

            contactNameStatusEl.textContent = 'Verificando disponibilidad...';
            contactNameStatusEl.classList.add('text-yellow-400');

            usernameCheckTimeout = setTimeout(async () => {
                await checkUsernameAvailability(username, contactNameStatusEl);
            }, 500); // Debounce 500ms
        });

        async function checkUsernameAvailability(username, statusElement) {
            try {
                // const arbSepoliaRpc = "https://sepolia-rollup.arbitrum.io/rpc";
                const checkProvider = new ethers.JsonRpcProvider(defaultNetworks[currentTokenIndex].API);
                

            // const provider = new ethers.JsonRpcProvider(optionsList[0].API);
            // let signer = await new ethers.Wallet(chatETHPrivKey)
            // const connectedSigner = await signer.connect(provider);
            // const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);

                const contract = new ethers.Contract(defaultNetworks[currentTokenIndex].CHATWALLET_DID_ADDRESS, CHATWALLET_DID_ABI, checkProvider);
                // const contract = new ethers.Contract(defaultNetworks[currentTokenIndex].CHATWALLET_DID_ADDRESS, defaultNetworks[currentTokenIndex].CHATWALLET_DID_ABI, checkProvider);
                didc = contract
                const address = await contract.usernameToAddress(username);

                if (address === ethers.ZeroAddress) {
                    statusElement.textContent = '✅ Nombre disponible';
                    statusElement.className = 'text-xs mt-1 min-h-[1rem] text-green-400';
                } else {
                    statusElement.textContent = '❌ Nombre no disponible';
                    statusElement.className = 'text-xs mt-1 min-h-[1rem] text-red-400';
                }
            } catch (error) {
                console.error("Error checking username:", error);
                statusElement.textContent = 'Error al verificar.';
                statusElement.className = 'text-xs mt-1 min-h-[1rem] text-red-400';
            }
        }


        userDidTrigger.addEventListener('click', () => {
            userDidWindow.classList.remove('hidden');
            userDidWindow.classList.add('flex');
        });

        closeUserDidWindow.addEventListener('click', () => {
            userDidWindow.classList.add('hidden');
            userDidWindow.classList.remove('flex');
        });
        
        userDidAvatar.addEventListener('click', () => {
            avatarUpload.click();
        });

        avatarUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    userDidAvatar.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
     </script>

<script type="module" >
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(new URL('service-worker.js', import.meta.url)).then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
 </body>
 
 </html>